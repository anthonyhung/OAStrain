---
title: "Pseudobulk"
author: "Anthony Hung"
date: "2020-02-24"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Comparison of single-cell data (pseudobulked) with bulk data from pilot study

```{r load}
library("Seurat")
library("slam")
library("dplyr")
library("RColorBrewer")
library("scales")
library("cowplot")
library("ggplot2")
library("ggfortify")
library("gplots")
library("ggpubr")

# load gene annotations
gene_anno <- read.delim("data/gene-annotation.txt",
                        sep = "\t")
# Load colors 
colors <- colorRampPalette(c(brewer.pal(9, "Blues")[1],brewer.pal(9, "Blues")[9]))(100)
pal <- c(brewer.pal(9, "Set1"), brewer.pal(8, "Set2"), brewer.pal(12, "Set3"))


#load pilot data bulk
raw_counts <- as.matrix(readRDS("data/raw_counts_relabeled.rds"))
# remove rows with 0 counts
raw_counts <- raw_counts[apply(raw_counts, 1, function(x) !all(x==0)),]
dim(raw_counts)

#load pilot data sc
ANT1.2 <- readRDS("data/ANT1_2.rds")
```

# pseudobulk the sc data

```{r pseudobulking}
scData <- data.frame(ANT1.2@assays$RNA@counts)
labels <- ANT1.2@meta.data$labels

PB_NA18856U <- row_sums(scData[, labels == "NA18856_Unstrain"])
PB_NA18855U <- row_sums(scData[, labels == "NA18855_Unstrain"])
PB_NA18855S <- row_sums(scData[, labels == "NA18855_Strain"])
PB_NA19160U <- row_sums(scData[, labels == "NA19160_Unstrain"])
PB_NA19160S <- row_sums(scData[, labels == "NA19160_Strain"])

PB_combined <- cbind(PB_NA18856U, PB_NA18855U, PB_NA18855S, PB_NA19160U, PB_NA19160S)
rownames(PB_combined) <- gene_anno$ensembl_gene_id[match(unlist(rownames(PB_combined)), gene_anno$external_gene_name)]

#Merge
Merged_bulk <- merge(raw_counts, PB_combined, by = "row.names")
row.names(Merged_bulk) <- Merged_bulk$Row.names
Merged_bulk <- Merged_bulk[,-1]
```

# Raw analysis

## Clustering (PCA)

```{r PCA cell atlas}
# Perform PCA
pca_genes <- prcomp(t(Merged_bulk), scale = T)

#Make PCA plots 

autoplot(pca_genes, label = T)
```

## Clustering (corr heatmap)

```{r corr heatmap}
#Corr heatmap
cors <- cor(Merged_bulk, method="spearman", use="pairwise.complete.obs")
heatmap.2(cors, scale="none", margins = c(12, 12), trace='none', denscol="white",
          cexCol = 0.1 + 1/log10(15), cexRow = 0.1 + 1/log10(15))
```
















# Normalization


## Normalize raw merged counts: upperquartile Normalization

```{r upperquartile normalization}
library(edgeR)
Merged_bulk <- DGEList(Merged_bulk, group = colnames(Merged_bulk))
upperquartile <- calcNormFactors(Merged_bulk, method = "upperquartile")
upperquartile <- cpm(upperquartile, log=TRUE, normalized.lib.sizes = T)
head(upperquartile)

# Look at density plots
plotDensities(upperquartile, legend="topright")
```

## Correlation heatmap of log2upperquartile normalized and unfiltered samples

```{r corr heatmap unfiltered upperquartile}
cors <- cor(upperquartile, method="spearman", use="pairwise.complete.obs")

labels <- sapply(strsplit(colnames(Merged_bulk),"_"), `[`, 1)

heatmap.2( cors, scale="none", col = colors, margins = c(12, 12), trace='none', denscol="white", labCol=labels, ColSideColors=pal[as.integer(as.factor(labels))], RowSideColors=pal[as.integer(as.factor(labels))], cexCol = 0.2 + 1/log10(15), cexRow = 0.2 + 1/log10(15))
```

## Boxplots of upperquartile across samples

```{r boxplot upperquartile}
library(reshape2)
meltupperquartile <- melt(upperquartile)
names(meltupperquartile) <- c("gene", "sampleID", "upperquartile")
p <- ggplot(meltupperquartile, aes(factor(sampleID), upperquartile)) 
p + geom_boxplot() + theme(axis.text.x = element_text(angle = 90))
```

## Filtering for lowly expressed genes (avg log2upperquartile > 2 in at least 10 samples)

```{r filter upperquartile}
cutoff <- 2

keep <- rowSums( upperquartile > cutoff ) >= 10

counts_upperquartile <- Merged_bulk[keep,]
filtered_upperquartile <- upperquartile[keep,]
dim(filtered_upperquartile)
```

## Boxplots of normalized+filtered counts across samples

```{r boxplot filt upperquartile}
melt_filt_upperquartile <- melt(filtered_upperquartile)
names(melt_filt_upperquartile) <- c("gene", "sampleID", "log2upperquartile")
p1 <- ggplot(melt_filt_upperquartile, aes(factor(sampleID), log2upperquartile)) 
p1 + geom_boxplot() + theme(axis.text.x = element_text(angle = 90))

plotDensities(filtered_upperquartile, legend = F)
```

## Correlation heatmap of log2upperquartile normalized and filtered samples

```{r corr heatmap filtered upperquartile}
cors <- cor(filtered_upperquartile, method="spearman", use="pairwise.complete.obs")

labels <- sapply(strsplit(colnames(Merged_bulk),"_"), `[`, 1)

heatmap.2( cors, scale="none", col = colors, margins = c(12, 12), trace='none', denscol="white", labCol=labels, ColSideColors=pal[as.integer(as.factor(labels))], RowSideColors=pal[as.integer(as.factor(labels))], cexCol = 0.2 + 1/log10(15), cexRow = 0.2 + 1/log10(15))
```

## Correlation between Pseudobulk and bulk from same replicate

```{r corr replicate}
cors
data.frame(filtered_upperquartile)  %>% ggplot(aes(x = `PB_NA18856U`, y = `X18856_3_U`)) +
     geom_point() + 
     geom_smooth(method='lm') + 
     stat_cor(method = "spearman", cor.coef.name = c("rho"))

data.frame(filtered_upperquartile)  %>% ggplot(aes(x = `PB_NA18855U`, y = `X18855_3_U`)) +
     geom_point() + 
     geom_smooth(method='lm') + 
     stat_cor(method = "spearman", cor.coef.name = c("rho"))

data.frame(filtered_upperquartile)  %>% ggplot(aes(x = `PB_NA18855S`, y = `X18855_3_S`)) +
     geom_point() + 
     geom_smooth(method='lm') + 
     stat_cor(method = "spearman", cor.coef.name = c("rho"))

data.frame(filtered_upperquartile)  %>% ggplot(aes(x = `PB_NA19160U`, y = `X19160_3_U`)) +
     geom_point() + 
     geom_smooth(method='lm') + 
     stat_cor(method = "spearman", cor.coef.name = c("rho"))

data.frame(filtered_upperquartile)  %>% ggplot(aes(x = `PB_NA19160S`, y = `X19160_3_S`)) +
     geom_point() + 
     geom_smooth(method='lm') + 
     stat_cor(method = "spearman", cor.coef.name = c("rho"))
```

























## Normalize raw merged counts: RLE Normalization

```{r RLE normalization}
library(edgeR)
Merged_bulk <- DGEList(Merged_bulk, group = colnames(Merged_bulk))
RLE <- calcNormFactors(Merged_bulk, method = "RLE")
RLE <- cpm(RLE, log=TRUE, normalized.lib.sizes = T)
head(RLE)

# Look at density plots
plotDensities(RLE, legend="topright")
```

## Correlation heatmap of log2RLE normalized and unfiltered samples

```{r corr heatmap unfiltered RLE}
cors <- cor(RLE, method="spearman", use="pairwise.complete.obs")

labels <- sapply(strsplit(colnames(Merged_bulk),"_"), `[`, 1)

heatmap.2( cors, scale="none", col = colors, margins = c(12, 12), trace='none', denscol="white", labCol=labels, ColSideColors=pal[as.integer(as.factor(labels))], RowSideColors=pal[as.integer(as.factor(labels))], cexCol = 0.2 + 1/log10(15), cexRow = 0.2 + 1/log10(15))
```

## Boxplots of RLE across samples

```{r boxplot RLE}
library(reshape2)
meltRLE <- melt(RLE)
names(meltRLE) <- c("gene", "sampleID", "RLE")
p <- ggplot(meltRLE, aes(factor(sampleID), RLE)) 
p + geom_boxplot() + theme(axis.text.x = element_text(angle = 90))
```

## Filtering for lowly expressed genes (avg log2RLE > 3 in at least 15 samples)

```{r filter RLE}
cutoff <- 3

keep <- rowSums( RLE > cutoff ) >= 15

counts_RLE <- Merged_bulk[keep,]
filtered_RLE <- RLE[keep,]
dim(filtered_RLE)
```

## Boxplots of normalized+filtered counts across samples

```{r boxplot filt RLE}
melt_filt_RLE <- melt(filtered_RLE)
names(melt_filt_RLE) <- c("gene", "sampleID", "log2RLE")
p1 <- ggplot(melt_filt_RLE, aes(factor(sampleID), log2RLE)) 
p1 + geom_boxplot() + theme(axis.text.x = element_text(angle = 90))

plotDensities(filtered_RLE, legend = F)
```

## Correlation heatmap of log2RLE normalized and filtered samples

```{r corr heatmap filtered RLE}
cors <- cor(filtered_RLE, method="spearman", use="pairwise.complete.obs")

labels <- sapply(strsplit(colnames(Merged_bulk),"_"), `[`, 1)

heatmap.2( cors, scale="none", col = colors, margins = c(12, 12), trace='none', denscol="white", labCol=labels, ColSideColors=pal[as.integer(as.factor(labels))], RowSideColors=pal[as.integer(as.factor(labels))], cexCol = 0.2 + 1/log10(15), cexRow = 0.2 + 1/log10(15))


```


## Correlation between Pseudobulk and bulk from same replicate

```{r corr replicate rle}
cors
data.frame(filtered_RLE)  %>% ggplot(aes(x = `PB_NA18856U`, y = `X18856_3_U`)) +
     geom_point() + 
     geom_smooth(method='lm') + 
     stat_cor(method = "spearman", cor.coef.name = c("rho"))

data.frame(filtered_RLE)  %>% ggplot(aes(x = `PB_NA18855U`, y = `X18855_3_U`)) +
     geom_point() + 
     geom_smooth(method='lm') + 
     stat_cor(method = "spearman", cor.coef.name = c("rho"))

data.frame(filtered_RLE)  %>% ggplot(aes(x = `PB_NA18855S`, y = `X18855_3_S`)) +
     geom_point() + 
     geom_smooth(method='lm') + 
     stat_cor(method = "spearman", cor.coef.name = c("rho"))

data.frame(filtered_RLE)  %>% ggplot(aes(x = `PB_NA19160U`, y = `X19160_3_U`)) +
     geom_point() + 
     geom_smooth(method='lm') + 
     stat_cor(method = "spearman", cor.coef.name = c("rho"))

data.frame(filtered_RLE)  %>% ggplot(aes(x = `PB_NA19160S`, y = `X19160_3_S`)) +
     geom_point() + 
     geom_smooth(method='lm') + 
     stat_cor(method = "spearman", cor.coef.name = c("rho"))
```

