---
title: "Pilot_GoMAnalysis"
author: "Anthony Hung"
date: "2020-01-29"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Applying topic modeling approaches on sc pilot data (first analysis with my data and outside data from other cell types)

Include data from:
     Pilot (iPSC-derived chondrocytes from 3 individuals x 2 treatment conditions; 10x)
     MSC-Pilot (Genevieve Housman's human data of iPSCs and iPSC-derived MSCs from human-chimp study; 10x)
          Also one dataset from chondrocytes (ipsc-derived)
     Hepatocytes (from liver homogenate; 10x)
     Chondrocytes (from OA patients; STRT protocol)
     
## Load Libraries

```{r load libraries}
library(Seurat)
library(tidyverse)
library(CountClust)
library(maptpx)
library(ggplot2)
library(MAST)
library(RColorBrewer)
library(ggfortify)
library(stringi)
library(stringr)
library(colorspace)
library(dplyr)
```

## Load in datasets and merge them

Load in datasets and create Seurat objects for each of them. Add metadata about the cell type they were assigned in their original contexts. Merge the Seurat object into one large object.

```{r Loading in data matrices}

if (file.exists("data/Combined_singlecell_data_first.rds") & file.exists("data/Combined_singlecell_data_allGenes.rds")){
Combined.common <- readRDS("data/Combined_singlecell_data_first.rds")
Combined.common.allGenes <- readRDS("data/Combined_singlecell_data_allGenes.rds")
} else {

#Pilot data
ANT1.2 <- readRDS("data/ANT1_2.rds")
ANT1.2 <- AddMetaData(ANT1.2, "iPSC-Chondrocyte", col.name = "Cell.Type")
dim(ANT1.2)

#Chondrocytes from OA patients (https://www.ncbi.nlm.nih.gov/pubmed/30026257) run through STRT protocol
chondro <- read.table("/project2/gilad/anthonyhung/Projects/OAStrain_project/outside_scData/GSE104782_allcells_UMI_count.txt.gz", header = T)
chondro_genes <- chondro[,1]
chondro_data <- chondro[,-1]
chondro <- chondro_data
rownames(chondro) <- chondro_genes
#load chondro cluster data from paper
chondro_metadata <- read_csv("data/GSE104782_Table_Cell_quality_information_and_clustering_information.csv")
#subset data to include only those that were assigned to a chondrocyte cluster in the paper
chondro.filtered <- chondro[,!is.na(chondro_metadata$Cluster)]
cluster.ident <- paste0("Chondro ", chondro_metadata$Cluster[!is.na(chondro_metadata$Cluster)])
#Create seurat object from chondrocytes
chondro.seurat <- CreateSeuratObject(chondro.filtered, project="Chondrocytes")
chondro.seurat <- AddMetaData(chondro.seurat, cluster.ident, col.name = "Cell.Type")
dim(chondro.seurat)

#iPSCs/MSCs/osteoblasts from Human/chimp panel. Combine all the datasets and subset for humans
ghousman_data_dir <- ("/project2/gilad/ghousman/skeletal-human-chimp/human-chimp-skeletal-scRNA/data/cellranger-data-full/")
gh_ipsc_1.1 <- readRDS(paste0(ghousman_data_dir, "h.c.dat.spp.GHO-1.rds"))
gh_msc_1.1 <- readRDS(paste0(ghousman_data_dir, "h.c.dat.spp.GHO-2.rds"))
gh_ipsc_1.2 <- readRDS(paste0(ghousman_data_dir, "h.c.dat.spp.HOU-10.rds"))
gh_msc_1.2 <- readRDS(paste0(ghousman_data_dir, "h.c.dat.spp.HOU-12.rds"))
gh_ipsc_2.1 <- readRDS(paste0(ghousman_data_dir, "h.c.dat.spp.HOU-1.rds"))
gh_msc_2.1 <- readRDS(paste0(ghousman_data_dir, "h.c.dat.spp.HOU-2.rds"))
gh_ipsc_3.1 <- readRDS(paste0(ghousman_data_dir, "h.c.dat.spp.HOU-9.rds"))
gh_msc_3.1 <- readRDS(paste0(ghousman_data_dir, "h.c.dat.spp.HOU-11.rds"))
gh_chondro <- readRDS(paste0(ghousman_data_dir, "h.c.dat.spp.GHO-4.rds")) #need to verify the sample name for the chondro/if these were processed yet
gh_big <- merge(gh_ipsc_1.1, y = c(gh_msc_1.1, gh_ipsc_1.2, gh_msc_1.2, gh_ipsc_2.1, gh_msc_2.1, gh_ipsc_3.1, gh_msc_3.1), 
                add.cell.ids = c("ipsc1.1", "msc1.1", "ipsc1.2", "msc1.2", "ipsc2.1", "msc2.1", "ipsc3.1", "msc3.1"), project = "ghousman")
gh_big_humans <- subset(gh_big, species == "Human")
gh_big_humans <- AddMetaData(gh_big_humans, "Ghousman", col.name = "orig.ident")
dim(gh_big_humans)

#Human Liver samples run through 10x (https://doi.org/10.1038/s41467-018-06318-7). This is a subset of the entire dataset, which is from whole liver homogenate. I used scViz to subset the data for clusters that were called hepatocytes in the original study (3490 cells)
liver <- readRDS("data/humanLiverSubset_hepatocytes.rds")
liver <- AddMetaData(liver, "Hepatocyte", col.name = "Cell.Type")
dim(liver)



# Merge Datasets

# Merge the seurat objects into one large one, keeping metadata about which study they originated in as well as their assigned cell type.

# merge based on common genes between ALL datasets
common.features <- Reduce(intersect, list(rownames(ANT1.2), rownames(chondro.seurat), rownames(gh_big_humans), rownames(liver)))
length(x = common.features)
Combined.common <- merge(ANT1.2[common.features, ], y = c(chondro.seurat[common.features, ], gh_big_humans[common.features, ], liver[common.features, ]), project = "Combined.common")

#merge keeping all genes
Combined.common.allGenes <- Combined.common <- merge(ANT1.2, y = c(chondro.seurat, gh_big_humans, liver), project = "Combined.common")
Combined.common.allGenes_noliver <- Combined.common <- merge(ANT1.2, y = c(chondro.seurat, gh_big_humans), project = "Combined.common")


saveRDS(Combined.common, "data/Combined_singlecell_data_first.rds")
saveRDS(Combined.common.allGenes, "data/Combined_singlecell_data_allGenes.rds")
saveRDS(Combined.common.allGenes_noliver, "data/Combined_singlecell_data_allGenes_noliver.rds")

}
```

## Check Expression of chondrocyte markers in chondrocyte data and pilot data

```{r}
#Chondrocytes from OA patients (https://www.ncbi.nlm.nih.gov/pubmed/30026257) run through STRT protocol
chondro <- read.table("/project2/gilad/anthonyhung/Projects/OAStrain_project/outside_scData/GSE104782_allcells_UMI_count.txt.gz", header = T)
chondro_genes <- chondro[,1]
chondro_data <- chondro[,-1]
chondro <- chondro_data
rownames(chondro) <- chondro_genes
#load chondro cluster data from paper
chondro_metadata <- read_csv("data/GSE104782_Table_Cell_quality_information_and_clustering_information.csv")
#subset data to include only those that were assigned to a chondrocyte cluster in the paper
chondro.filtered <- chondro[,!is.na(chondro_metadata$Cluster)]
cluster.ident <- paste0("Chondro ", chondro_metadata$Cluster[!is.na(chondro_metadata$Cluster)])
#Create seurat object from chondrocytes
chondro.seurat <- CreateSeuratObject(chondro.filtered, project="Chondrocytes")
chondro.seurat <- AddMetaData(chondro.seurat, cluster.ident, col.name = "Cell.Type")
dim(chondro.seurat)

VlnPlot(object=chondro.seurat, features = c("SOX9", "ACAN", "COL2A1", "COL11A1", "SOX5", "SOX6"))
VlnPlot(object=chondro.seurat, features = c("TGFB3"))


#Pilot data
ANT1.2 <- readRDS("data/ANT1_2.rds")
ANT1.2 <- AddMetaData(ANT1.2, "iPSC-Chondrocyte", col.name = "Cell.Type")
dim(ANT1.2)
VlnPlot(object=ANT1.2, features = c("SOX9", "ACAN", "COL2A1", "COL11A1", "SOX5", "SOX6"))
VlnPlot(object=ANT1.2, features = c("TGFB3"))

```


![Cell Type Clusters from original paper](../analysis/figures/scviz1.png)
![Subsetting gate drawn in scViz](../analysis/figures/scviz2.png)

## Analysis of combined dataset in Seurat

Now we can look at the cells in Seurat, including PCA and UMAP

```{r Seurat analysis}
VlnPlot(Combined.common, features = c("nFeature_RNA", "nCount_RNA"), ncol = 2, group.by = "orig.ident")
VlnPlot(Combined.common, features = c("nFeature_RNA", "nCount_RNA"), ncol = 2, group.by = "Cell.Type")

# FeatureScatter is typically used to visualize feature-feature relationships, but can be used
# for anything calculated by the object, i.e. columns in object metadata, PC scores etc.

FeatureScatter(Combined.common, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")

if (file.exists("data/Combined_singlecell_data.rds") & file.exists("data/Combined_singlecell_data_allGenes_normalized.rds")){
Combined.common <- readRDS("data/Combined_singlecell_data.rds")
Combined.common.allGenes <- readRDS("data/Combined_singlecell_data_allGenes_normalized.rds")
} else {

#Normalize Data
Combined.common <- NormalizeData(Combined.common, normalization.method = "LogNormalize", scale.factor = 10000)

# Feature selection
Combined.common <- FindVariableFeatures(Combined.common, selection.method = "vst", nfeatures = 2000)

# Scaling Data
scale_data <- function(seurat.obj){
  all.genes <- rownames(seurat.obj)
  return(ScaleData(seurat.obj, features = all.genes))
}

Combined.common <- scale_data(Combined.common)

# Dimensionality Reduction
#Using the highly variable features selected above, perform PCA
nPC <- 100
Combined.common <- RunPCA(Combined.common, features = VariableFeatures(object = Combined.common), npcs = nPC)


#UMAP
num_PCs <- 50

Combined.common <- FindNeighbors(Combined.common, dims = 1:num_PCs)
Combined.common <- FindClusters(Combined.common, resolution = 0.5)

#Run UMAP
Combined.common <- RunUMAP(Combined.common, dims = 1:num_PCs)
saveRDS(Combined.common, "data/Combined_singlecell_data.rds")






#Normalize Data
Combined.common.allGenes <- NormalizeData(Combined.common.allGenes, normalization.method = "LogNormalize", scale.factor = 10000)

# Feature selection

Combined.common.allGenes <- FindVariableFeatures(Combined.common.allGenes, selection.method = "vst", nfeatures = 2000)

# Scaling Data

scale_data <- function(seurat.obj){
  all.genes <- rownames(seurat.obj)
  return(ScaleData(seurat.obj, features = all.genes))
}

Combined.common.allGenes <- scale_data(Combined.common.allGenes)

# Dimensionality Reduction

#Using the highly variable features selected above, perform PCA

nPC <- 100
Combined.common.allGenes <- RunPCA(Combined.common.allGenes, features = VariableFeatures(object = Combined.common.allGenes), npcs = nPC)


#UMAP
num_PCs <- 50

Combined.common.allGenes <- FindNeighbors(Combined.common.allGenes, dims = 1:num_PCs)
Combined.common.allGenes <- FindClusters(Combined.common.allGenes, resolution = 0.5)

#Run UMAP
Combined.common.allGenes <- RunUMAP(Combined.common.allGenes, dims = 1:num_PCs)
saveRDS(Combined.common.allGenes, "data/Combined_singlecell_data_allGenes_normalized.rds")
}



#Plots 

#Var features
plot_variable_features <- function(seurat.obj){
  # Identify the 10 most highly variable genes
  top10 <- head(VariableFeatures(seurat.obj), 10)
  
  # plot variable features with and without labels
  plot1 <- VariableFeaturePlot(seurat.obj) + 
       theme(legend.position="bottom")
  plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE) +
       theme(legend.position="bottom")
  return(CombinePlots(plots = list(plot1, plot2)))
}

plot_variable_features(Combined.common)


# Examine and visualize PCA results a few different ways
print(Combined.common[["pca"]], dims = 1:5, nfeatures = 5)
VizDimLoadings(Combined.common, dims = 1:2, reduction = "pca")

DimPlot(Combined.common, reduction = "pca", group.by = "Cell.Type")

DimHeatmap(Combined.common, dims = 1:15, cells = 500, balanced = TRUE)


#extract scaled data for highlyvargenes to a matrix outside of seurat to perform PCA and examine varexplained
scaled <- Combined.common@assays$RNA@scale.data[VariableFeatures(Combined.common),]
dim(scaled)

pca_genes <- prcomp(t(scaled), scale = F)
scores <- pca_genes$x

autoplot(pca_genes, label = T)

#% Var explained by top 10 pcs
for(n in 1:10){
     print(n)
     print(summary(pca_genes)$importance[2,n]*100)
}

nPC <- 100
#elbow plot
ElbowPlot(Combined.common, ndims = nPC) #50 PCs?

#UMAP
DimPlot(Combined.common, reduction = "umap", group.by = "Cell.Type")

```

## Semi-supervised clustering with classtpx

```{r classtpx}
# Grades of Membership analysis with classtpx

library(classtpx)
library(Seurat)
library(ggplot2)
library("RColorBrewer")
library("scales")
library("cowplot")
library("CountClust")
library("maptpx")
library("MAST")
library("ggplot2")
library("ggfortify")
library("gplots")


if (file.exists("data/gom_sup_3.rda")){
     tpx.clust <- readRDS(file="data/gom_sup_3.rda")
} else {

Combined.common_noliver <- readRDS("/project2/gilad/anthonyhung/Projects/OAStrain_project/OAStrain/data/Combined_singlecell_data_noliver.rds")
dim(Combined.common_noliver)

# specify the fixed loadings for certain cells (1 = iPSC, 2 = MSC, 3 = chondrocyte)
counts_allgenes <- as.matrix(Combined.common_noliver@assays$RNA@counts)
labels <- Combined.common_noliver@meta.data$Cell.Type

#labels for "known" clusters
idx.ips <- which(labels=="iPSC")
idx.msc <- which(labels=="MSC")
idx.cho <- which(grepl("Chondro ", labels))
kwn.smp <- c(idx.ips,idx.msc,idx.cho)

class.labs <- c(rep("iPSC", length(idx.ips)),
                rep("MSC", length(idx.msc)),
                rep("Chondrocyte", length(idx.cho)))

#Perform topic modeling k=3
#Save GoM data
k=3
print(k)
tpx.clust <- classtpx::class_topics(
     t(counts_allgenes),
     K=k,
     known_samples=kwn.smp,
     class_labs=class.labs,
     method="omega.fix",
     tol=1)
saveRDS(tpx.clust, file=paste0("/project2/gilad/anthonyhung/Projects/OAStrain_project/OAStrain/data/gom_sup_",k,".rda"))
}

omega <- tpx.clust$omega
annotation <- data.frame(
     sample_id = paste0("X", c(1:NROW(omega))),
     tissue_label = as.factor(labels))
rownames(omega) <- annotation$sample_id
CountClust::StructureGGplot(omega = omega,
                            annotation = annotation,
                            palette = RColorBrewer::brewer.pal(8, "Accent"),
                            yaxis_label = "Tissue/Cell Type",
                            order_sample = TRUE,
                            axis_tick = list(axis_ticks_length = .1,
                                             axis_ticks_lwd_y = .1,
                                             axis_ticks_lwd_x = .1,
                                             axis_label_size = 7,
                                             axis_label_face = "bold")
)

ggsave("output/structureplot.png")

```




## Analysis of the Topics within the Topic models generated for each dataset


```{r functions to visualize GoM }
visualizeGoM <- function(omega, seuratobject, data){
  omega <- omega[match(colnames(seuratobject@assays$RNA), colnames(data)),]
  labs_clus <- colnames(omega)[apply(omega,1,which.max)]
  data_ggplot <- data.frame(labels = labs_clus,
                          umap1 = seuratobject@reductions$umap@cell.embeddings[, 1],
                          umap2 = seuratobject@reductions$umap@cell.embeddings[, 2])
  plot1 <- ggplot(data_ggplot) + theme(panel.background = element_rect(colour = "black", size = 1),
                                     panel.grid.major = element_blank(),
                                     panel.grid.minor = element_blank(),
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(),
                                     axis.ticks = element_blank(),
                                     legend.text = element_text(size = 15)) + geom_point(aes(x = umap1, y = umap2, color = labels), size = 0.5) + labs(x = 'tSNE 1', y = 'tSNE 2', title = '') + scale_color_discrete('')
  return(plot1)
}

visualizeGoM_topic_gradients <- function(omega, seuratobject, data){
  omega <- omega[match(colnames(seuratobject@assays$RNA), colnames(data)),]
  ntopics <- ncol(omega)
  for (n in 1:ntopics){
  data_ggplot <- data.frame(proportion = omega[,n],
                          umap1 = seuratobject@reductions$umap@cell.embeddings[, 1],
                          umap2 = seuratobject@reductions$umap@cell.embeddings[, 2])
  plot.gradient <- ggplot(data_ggplot) + theme(panel.background = element_rect(colour = "black", size = 1),
                                     panel.grid.major = element_blank(),
                                     panel.grid.minor = element_blank(),
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(),
                                     axis.ticks = element_blank(),
                                     legend.text = element_text(size = 15)) + geom_point(aes(x = umap1, y = umap2, color = proportion), size = 0.5) + labs(x = 'tSNE 1', y = 'tSNE 2', title = '') + scale_colour_gradient(low="grey", high="red")
  plot(plot.gradient)
  }
}



plot_structure_plot <- function(omega, seuratobject){
     labels <- sapply(strsplit(seuratobject@meta.data$Cell.Type," "), `[`, 1)
     annotation <- data.frame(
          sample_id = rownames(omega),
          tissue_label = labels
          )
     StructureGGplot(omega = omega,
                     annotation = annotation,
                     #palette = my_color_palette1,
                     order_sample = TRUE,
                     axis_tick = list(axis_ticks_length = .1,
                                      axis_ticks_lwd_y = .1,
                                      axis_ticks_lwd_x = .1,
                                      axis_label_size = 7,
                                      axis_label_face = "bold"))
     }


make_topic_plots <- function(omega, celltypes){
  omega <- as.data.frame(omega)
  omega <- cbind(omega,celltypes)
  for (k in 1:(ncol(omega)-1)) {
    base_plot <- ggplot(data = omega, mapping = aes(x = celltypes, y = omega[,k])) + labs(y = paste0("Topic ", k, " value"), x = paste0("Cell Type")) + theme(axis.text.x = element_text(angle = -20, hjust = 0, vjust = 0))
    plot(base_plot + geom_violin(width = 1.5, fill = "skyblue",color = "skyblue") +
      geom_boxplot(width = 0.1,outlier.shape = NA, alpha = 0.2))
   }
}
```

Use the CountClust::ExtractTopFeatures function to obtain KL measurement scores for the top 100 genes per cluster that best distinguish that cluster from the rest.

```{r cluster annotations function}
annotate_clusters <- function(theta_mat, countmatrix){
  top_features <- ExtractTopFeatures(theta_mat,
                                     top_features=100,
                                     method="poisson",
                                     options="min")
  gene_vector <- do.call(rbind, lapply(1:dim(top_features[[1]])[1], function(x) rownames(countmatrix)[top_features[[1]][x,]]))
  scores_vector <- do.call(rbind, lapply(1:dim(top_features[[1]])[1], function(x) top_features[[2]][x,]))
  print(gene_vector)
  print(scores_vector)
}
```

## Apply Visualization/annotation functions to GoM results

```{r k of 3}
visualizeGoM(omega=Combined_GoM3[[1]]$clust_3$omega, seuratobject=Combined.common, data=Combined_counts)
visualizeGoM_topic_gradients(omega=Combined_GoM3[[1]]$clust_3$omega, seuratobject=Combined.common, data=Combined_counts)
#plot_structure_plot(omega=Combined_GoM3[[1]]$clust_3$omega, seuratobject=Combined.common)
make_topic_plots(Combined_GoM3[[1]]$clust_3$omega, Combined_counts_celltypes)
annotate_clusters(Combined_GoM3[[1]]$clust_3$theta, Combined_counts)
```

```{r k of 4}
visualizeGoM(omega=Combined_GoM4[[1]]$clust_4$omega, seuratobject=Combined.common, data=Combined_counts)
visualizeGoM_topic_gradients(omega=Combined_GoM4[[1]]$clust_4$omega, seuratobject=Combined.common, data=Combined_counts)
#plot_structure_plot(omega=Combined_GoM4[[1]]$clust_4$omega, seuratobject=Combined.common)
make_topic_plots(Combined_GoM4[[1]]$clust_4$omega, Combined_counts_celltypes)
annotate_clusters(Combined_GoM4[[1]]$clust_4$theta, Combined_counts)
```

```{r k of 5}
visualizeGoM(omega=Combined_GoM5[[1]]$clust_5$omega, seuratobject=Combined.common, data=Combined_counts)
visualizeGoM_topic_gradients(omega=Combined_GoM5[[1]]$clust_5$omega, seuratobject=Combined.common, data=Combined_counts)
#plot_structure_plot(omega=Combined_GoM5[[1]]$clust_5$omega, seuratobject=Combined.common)
make_topic_plots(Combined_GoM5[[1]]$clust_5$omega, Combined_counts_celltypes)
annotate_clusters(Combined_GoM5[[1]]$clust_5$theta, Combined_counts)
```

```{r k of 6}
visualizeGoM(omega=Combined_GoM6[[1]]$clust_6$omega, seuratobject=Combined.common, data=Combined_counts)
visualizeGoM_topic_gradients(omega=Combined_GoM6[[1]]$clust_6$omega, seuratobject=Combined.common, data=Combined_counts)
#plot_structure_plot(omega=Combined_GoM6[[1]]$clust_6$omega, seuratobject=Combined.common)
make_topic_plots(Combined_GoM6[[1]]$clust_6$omega, Combined_counts_celltypes)
annotate_clusters(Combined_GoM6[[1]]$clust_6$theta, Combined_counts)
```

```{r k of 7}
visualizeGoM(omega=Combined_GoM7[[1]]$clust_7$omega, seuratobject=Combined.common, data=Combined_counts)
visualizeGoM_topic_gradients(omega=Combined_GoM7[[1]]$clust_7$omega, seuratobject=Combined.common, data=Combined_counts)
#plot_structure_plot(omega=Combined_GoM7[[1]]$clust_7$omega, seuratobject=Combined.common)
make_topic_plots(Combined_GoM7[[1]]$clust_7$omega, Combined_counts_celltypes)
annotate_clusters(Combined_GoM7[[1]]$clust_7$theta, Combined_counts)
```

```{r k of 8}
visualizeGoM(omega=Combined_GoM8[[1]]$clust_8$omega, seuratobject=Combined.common, data=Combined_counts)
visualizeGoM_topic_gradients(omega=Combined_GoM8[[1]]$clust_8$omega, seuratobject=Combined.common, data=Combined_counts)
#plot_structure_plot(omega=Combined_GoM8[[1]]$clust_8$omega, seuratobject=Combined.common)
make_topic_plots(Combined_GoM8[[1]]$clust_8$omega, Combined_counts_celltypes)
annotate_clusters(Combined_GoM8[[1]]$clust_8$theta, Combined_counts)
```
























## Code for loading in cell atlas samples 

First compute correlations between each individual cell in ANT1.2 and each of the primary cell lines in the cell atlas dataset to assign labels. Then use those primary cell lines to compute memberships in clusters

```{r cell atlas assignment}
###SCRIPTS GOTTEN FROM BINGQING XIE###

###compute correlation matrix between sample and cell lines in cellAtlas
###object: Seurat object
###cell.line: cell Atlas expression matrix
###CorMethod: correlation method to use
ComputeCorMat <- function(object, cell.line, CorMethod="pearson"){

	data=GetAssayData(object, slot="data", assay="RNA") #additions - added slot and assay info because SCT assay 
    data_norm <- apply(data, 2, function(x) x/sum(x))
    data_libsize <- apply(data_norm, 2, function(x) x * 1e+06)

    Data.use <- data_libsize

    gene.id <- rownames(Data.use)
    gene.ref <- rownames(cell.line)
    common <- intersect(gene.id, gene.ref)
    logxx <- apply(Data.use[common, ], 2, function(x) {
        log(x + 0.1)
    })
    selected.cell.line <- apply(cell.line[common, ], 2, function(x) {
        x - mean(x)
    })
    n <- ncol(logxx)
    m <- ncol(cell.line)
    cor.mat <- matrix(0, nrow = n, ncol = m)
    for (j in 1:m) {
        for (i in 1:n) {
            cor.mat[i,j] <- cor(logxx[,i], selected.cell.line[,j], method=CorMethod)
        }
    }
    rownames(cor.mat) <- colnames(Data.use)
    colnames(cor.mat) <- colnames(cell.line)
	return(cor.mat)
}

###Assign clustered cell atlas as cell type to all cells in the sample
###object: seurat object
###cor.mat: correlation matrix
###K: number of clusters generated from cell atlas
###topCorrelation: number of highest correlated cell lines in cell atlas to be assigned, set to 1 to extract only the top correlated cell line
AssignClusteredLabel <- function (object, cor.mat, K, topCorrelation, dist.method="euclidean", hclust.method="ward.D"){
	
	dist_mat <- dist(t(cor.mat), method=dist.method)
	hclust_avg_cellline <- hclust(dist_mat, method=hclust.method)
	#plot(hclust_avg_cellline)

	cut_cellline <- cutree(hclust_avg_cellline, k = K)
	cellline_abstract=sapply(strsplit(as.character(colnames(cor.mat)), "\\_"), "[[", 2)
	clusteredCellline=rbind(cut_cellline,cellline_abstract)
	nametable=rep('n',K)
	for(i in 1:K){
		indexy=as.character(i)
		nametable[i]=paste0(names(sort(table(clusteredCellline[2,clusteredCellline[1,]==indexy]),decreasing=TRUE)),collapse='_' )
	}
	assignm=apply(cor.mat,1,function(x){
		indexy=names(which.max(table(clusteredCellline[1,names(sort(x,decreasing=T)[1:topCorrelation])])))
		y=paste0(names( sort(table(clusteredCellline[2,clusteredCellline[1,]==indexy]),decreasing=TRUE)),collapse='_' )
		return(y)
	})
	object$clusteredCellAtlas=assignm
	return(object)
}

#Load cell atlas data matrix (currated by GAH)
#references: Human Primary Cell Atlas (Mabbott et al., 2013)
#description: 713 microarray samples processed and normalized as described in Aran et al. (2019); each sample assigned to one of 37 main cell types and 157 subtypes
#library(SingleR, lib.loc="") #only available on R/3.6.0??? ...BUT able to install on local computer
#if(!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
#BiocManager::install("SingleR")
#library(SingleR)
#hpca.se <- HumanPrimaryCellAtlasData()
#write.table(hpca.se@assays@data$logcounts, file="G:/My Drive/Documents/University of Chicago/Gilad Lab/project notes/study-human-chimp-bone-cartilage-rna/study-collections/sc-rna/HumanPrimaryCellAtlasData-SingleR")
#write.csv(as.data.frame(hpca.se@colData),file="G:/My Drive/Documents/University of Chicago/Gilad Lab/project notes/study-human-chimp-bone-cartilage-rna/study-collections/sc-rna/HumanPrimaryCellAtlasLabels-SingleR.csv", row.names=TRUE)
#manually currated HumanPrimaryCellAtlasLabels-SingleR.csv
#transferred files to cluster
hpca <- read.table("/project2/gilad/ghousman/skeletal-human-chimp/human-chimp-skeletal-scRNA/data/HumanPrimaryCellAtlasData-SingleR")
hpca.names <- read.csv("/project2/gilad/ghousman/skeletal-human-chimp/human-chimp-skeletal-scRNA/data/HumanPrimaryCellAtlasLabels-SingleR.csv", row.names=1)
hpca.names$label <- paste0(hpca.names$geo.curated,"_",hpca.names$label.curated)
i=1
while(i <= length(colnames(hpca))) {
  colnames(hpca)[i] <- hpca.names$label[rownames(hpca.names)==colnames(hpca)[i]]
  i=i+1
}

hpca_subset <- hpca[, grepl(c("iPSC|MSC|Chondrocytes|Osteoblasts|Adipocyte"), colnames(hpca))]

#Compute the correlation matrix use a seurat object and human primary cell atlas matrix as input
cor.mat.hpca <- ComputeCorMat(ANT1.2,hpca)

cor.mat.hpca_subset <- ComputeCorMat(ANT1.2,hpca_subset)


#Add a metadata column "clusteredCellAtlas" to the object
ANT1.2 <- AssignClusteredLabel(ANT1.2, cor.mat.hpca, K=100, topCorrelation=5)

#Visualize assigned clusters
DimPlot(ANT1.2, reduction="umap", group.by="clusteredCellAtlas", pt.size=0.5)
as.data.frame(table(ANT1.2$clusteredCellAtlas))
df_clusteredCellAtlas <- as.data.frame(cbind(ANT1.2$clusteredCellAtlas, ANT1.2$labels)) 
df_clusteredCellAtlas <- dplyr::rename(dplyr::count(df_clusteredCellAtlas, `V1`, `V2`), Freq = n) %>% arrange(V2)
table(df_clusteredCellAtlas$V2)


DimPlot(ANT1.2, reduction="umap", group.by="labels", split.by="clusteredCellAtlas", pt.size=0.5, ncol = 3) +
  theme(plot.title = element_text(size=1)) +
  labs(x="UMAP1",y="UMAP2")



#subset data
#Add a metadata column "clusteredCellAtlas" to the object
ANT1.2 <- AssignClusteredLabel(ANT1.2, cor.mat.hpca_subset, K=10, topCorrelation=5)

#Visualize assigned clusters
DimPlot(ANT1.2, reduction="umap", group.by="clusteredCellAtlas", pt.size=0.5)
as.data.frame(table(ANT1.2$clusteredCellAtlas))
df_clusteredCellAtlas <- as.data.frame(cbind(ANT1.2$clusteredCellAtlas, ANT1.2$labels)) 
df_clusteredCellAtlas <- dplyr::rename(dplyr::count(df_clusteredCellAtlas, `V1`, `V2`), Freq = n) %>% arrange(V2)
table(df_clusteredCellAtlas$V2)


DimPlot(ANT1.2, reduction="umap", group.by="labels", split.by="clusteredCellAtlas", pt.size=0.5, ncol = 3) +
  theme(plot.title = element_text(size=1)) +
  labs(x="UMAP1",y="UMAP2")

```


# Run FastTopics on only my pilot data (iPSC-chondrocytes)

```{r FastTopics only pilot all}
library(fastTopics)
SCT_integrated <- readRDS("data/SCT_ANT12_integrated.rds")
counts <- SCT_integrated@assays$RNA@counts
counts <- counts[,colSums(counts > 0) > 0]

# fitall_2 <- fit_poisson_nmf(counts,k = 2,numiter = 200)
# fitall.multinom_2 <- poisson2multinom(fitall_2)
# saveRDS(fitall.multinom_2, "output/fasttopics/fasttopics_k=2.rds")
# 
# fitall_3 <- fit_poisson_nmf(counts,k = 3,numiter = 200)
# fitall.multinom_3 <- poisson2multinom(fitall_3)
# saveRDS(fitall.multinom_3, "output/fasttopics/fasttopics_k=3.rds")
# 
# fitall_4 <- fit_poisson_nmf(counts,k = 4,numiter = 200)
# fitall.multinom_4 <- poisson2multinom(fitall_4)
# saveRDS(fitall.multinom_4, "output/fasttopics/fasttopics_k=4.rds")
# 
# fitall_5 <- fit_poisson_nmf(counts,k = 5,numiter = 200)
# fitall.multinom_5 <- poisson2multinom(fitall_5)
# saveRDS(fitall.multinom_5, "output/fasttopics/fasttopics_k=5.rds")
# 
# fitall_6 <- fit_poisson_nmf(counts,k = 6,numiter = 200)
# fitall.multinom_6 <- poisson2multinom(fitall_6)
# saveRDS(fitall.multinom_6, "output/fasttopics/fasttopics_k=6.rds")
# 
# fitall_7 <- fit_poisson_nmf(counts,k = 7,numiter = 200)
# fitall.multinom_7 <- poisson2multinom(fitall_7)
# saveRDS(fitall.multinom_7, "output/fasttopics/fasttopics_k=7.rds")
# 
# fitall_8 <- fit_poisson_nmf(counts,k = 8,numiter = 200)
# fitall.multinom_8 <- poisson2multinom(fitall_8)
# saveRDS(fitall.multinom_8, "output/fasttopics/fasttopics_k=8.rds")

fitall.multinom_2 <- readRDS("output/fasttopics/fasttopics_k=2.rds")
fitall.multinom_3 <- readRDS("output/fasttopics/fasttopics_k=3.rds")
fitall.multinom_4 <- readRDS("output/fasttopics/fasttopics_k=4.rds")
fitall.multinom_5 <- readRDS("output/fasttopics/fasttopics_k=5.rds")
fitall.multinom_6 <- readRDS("output/fasttopics/fasttopics_k=6.rds")
fitall.multinom_7 <- readRDS("output/fasttopics/fasttopics_k=7.rds")
fitall.multinom_8 <- readRDS("output/fasttopics/fasttopics_k=8.rds")
```

Visualize

```{r visualize gom All}
plot_UMAP_GoM <- function(seurat.obj, fit){
     k <- ncol(fit$F)
     for(topic in 1:k){
          plot(FeaturePlot(seurat.obj, paste0("k", topic)))
     }
}

for(fit in list(fitall.multinom_2, fitall.multinom_3, fitall.multinom_4, fitall.multinom_5, fitall.multinom_6, fitall.multinom_7, fitall.multinom_8)){
     print(ncol(fit$F))
     plot(DimPlot(SCT_integrated, reduction = "umap", group.by = "labels"))
     plot(DimPlot(SCT_integrated, reduction = "umap", group.by = "seurat_clusters"))
     plot_UMAP_GoM(SCT_integrated, fit)
}
```

Exploratory: Fit fastTopics GoM model to a single sample, then use the semi-supervised version of fastTopics to fix these loadings and fit the rest of the cells

```{r fit fasttopics gom 1 sample}
#subset
NA18855_unstrain_only <- counts[SCT_integrated@meta.data$labels == "NA18855_Unstrain"]
NA18855_unstrain_only <- NA18855_unstrain_only[,colSums(NA18855_unstrain_only > 0) > 0]
NA18856_unstrain_only <- counts[SCT_integrated@meta.data$labels == "NA18856_Unstrain"]
NA18856_unstrain_only <- NA18856_unstrain_only[,colSums(NA18856_unstrain_only > 0) > 0]
NA19160_unstrain_only <- counts[SCT_integrated@meta.data$labels == "NA19160_Unstrain"]
NA19160_unstrain_only <- NA19160_unstrain_only[,colSums(NA19160_unstrain_only > 0) > 0]

#Fit GoM with k=2 (and k=3,4 in case that is more interpretable)
fit18855_2 <- fit_poisson_nmf(NA18855_unstrain_only, k = 2, numiter = 200)
fit18855.multinom_2 <- poisson2multinom(fit18855_2)
saveRDS(fit18855.multinom_2, "output/fasttopics/fasttopics_NA18855_only_k=2.rds")
fit18855_3 <- fit_poisson_nmf(NA18855_unstrain_only, k = 3, numiter = 200)
fit18855.multinom_3 <- poisson2multinom(fit18855_3)
saveRDS(fit18855.multinom_3, "output/fasttopics/fasttopics_NA18855_only_k=3.rds")
fit18855_4 <- fit_poisson_nmf(NA18855_unstrain_only, k = 4, numiter = 200)
fit18855.multinom_4 <- poisson2multinom(fit18855_4)
saveRDS(fit18855.multinom_4, "output/fasttopics/fasttopics_NA18855_only_k=4.rds")

fit18856_2 <- fit_poisson_nmf(NA18856_unstrain_only, k = 2, numiter = 200)
fit18856.multinom_2 <- poisson2multinom(fit18856_2)
saveRDS(fit18856.multinom_2, "output/fasttopics/fasttopics_NA18856_only_k=2.rds")
fit18856_3 <- fit_poisson_nmf(NA18856_unstrain_only, k = 3, numiter = 200)
fit18856.multinom_3 <- poisson2multinom(fit18856_3)
saveRDS(fit18856.multinom_3, "output/fasttopics/fasttopics_NA18856_only_k=3.rds")
fit18856_4 <- fit_poisson_nmf(NA18856_unstrain_only, k = 4, numiter = 200)
fit18856.multinom_4 <- poisson2multinom(fit18856_4)
saveRDS(fit18856.multinom_4, "output/fasttopics/fasttopics_NA18856_only_k=4.rds")

fit19160_2 <- fit_poisson_nmf(NA19160_unstrain_only, k = 2, numiter = 200)
fit19160.multinom_2 <- poisson2multinom(fit19160_2)
saveRDS(fit19160.multinom_2, "output/fasttopics/fasttopics_NA19160_only_k=2.rds")
fit19160_3 <- fit_poisson_nmf(NA19160_unstrain_only, k = 3, numiter = 200)
fit19160.multinom_3 <- poisson2multinom(fit19160_3)
saveRDS(fit19160.multinom_3, "output/fasttopics/fasttopics_NA19160_only_k=3.rds")
fit19160_4 <- fit_poisson_nmf(NA19160_unstrain_only, k = 4, numiter = 200)
fit19160.multinom_4 <- poisson2multinom(fit19160_4)
saveRDS(fit19160.multinom_4, "output/fasttopics/fasttopics_NA19160_only_k=4.rds")
```

Now, use the models that have been fit to fit the remaining samples

```{r apply fit model to all samples}

```

