---
title: "Pilot_GoMAnalysis"
author: "Anthony Hung"
date: "2020-01-29"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Applying topic modeling approaches on sc pilot data

Include data from:
     Pilot (iPSC-derived chondrocytes from 3 individuals x 2 treatment conditions; 10x)
     MSC-Pilot (Genevieve Housman's human data of iPSCs and iPSC-derived MSCs from human-chimp study; 10x)
     Hepatocytes (from liver homogenate; 10x)
     Chondrocytes (from OA patients; STRT protocol)
     
# Load Libraries

```{r load libraries}
library(Seurat)
library(tidyverse)
```

# Load in datasets
Load in datasets and create Seurat objects for each of them. Add metadata about the cell type they were assigned in their original contexts.

```{r Loading in data matrices}
#Pilot data
ANT1.2 <- readRDS("data/ANT1_2.rds")
ANT1.2 <- AddMetaData(ANT1.2, "iPSC-Chondrocyte", col.name = "Cell.Type")
dim(ANT1.2)

#Chondrocytes from OA patients (https://www.ncbi.nlm.nih.gov/pubmed/30026257) run through STRT protocol
chondro <- read.table("/project2/gilad/anthonyhung/Projects/OAStrain_project/outside_scData/GSE104782_allcells_UMI_count.txt.gz", header = T)
chondro_genes <- chondro[,1]
chondro_data <- chondro[,-1]
chondro <- chondro_data
rownames(chondro) <- chondro_genes
#load chondro cluster data from paper
chondro_metadata <- read_csv("data/GSE104782_Table_Cell_quality_information_and_clustering_information.csv")
#subset data to include only those that were assigned to a chondrocyte cluster in the paper
chondro.filtered <- chondro[,!is.na(chondro_metadata$Cluster)]
cluster.ident <- paste0("Chondro ", chondro_metadata$Cluster[!is.na(chondro_metadata$Cluster)])
#Create seurat object from chondrocytes
chondro.seurat <- CreateSeuratObject(chondro.filtered, project="Chondrocytes")
chondro.seurat <- AddMetaData(chondro.seurat, cluster.ident, col.name = "Cell.Type")
dim(chondro.seurat)

#iPSCs/MSCs/osteoblasts from Human/chimp panel. Combine all the datasets and subset for humans
ghousman_data_dir <- ("/project2/gilad/ghousman/skeletal-human-chimp/human-chimp-skeletal-scRNA/data/cellranger-data-full/")
gh_ipsc_1.1 <- readRDS(paste0(ghousman_data_dir, "h.c.dat.spp.GHO-1.rds"))
gh_msc_1.1 <- readRDS(paste0(ghousman_data_dir, "h.c.dat.spp.GHO-2.rds"))
gh_ipsc_1.2 <- readRDS(paste0(ghousman_data_dir, "h.c.dat.spp.HOU-10.rds"))
gh_msc_1.2 <- readRDS(paste0(ghousman_data_dir, "h.c.dat.spp.HOU-12.rds"))
gh_ipsc_2.1 <- readRDS(paste0(ghousman_data_dir, "h.c.dat.spp.HOU-1.rds"))
gh_msc_2.1 <- readRDS(paste0(ghousman_data_dir, "h.c.dat.spp.HOU-2.rds"))
gh_ipsc_3.1 <- readRDS(paste0(ghousman_data_dir, "h.c.dat.spp.HOU-9.rds"))
gh_msc_3.1 <- readRDS(paste0(ghousman_data_dir, "h.c.dat.spp.HOU-11.rds"))
gh_big <- merge(gh_ipsc_1.1, y = c(gh_msc_1.1, gh_ipsc_1.2, gh_msc_1.2, gh_ipsc_2.1, gh_msc_2.1, gh_ipsc_3.1, gh_msc_3.1), 
                add.cell.ids = c("ipsc1.1", "msc1.1", "ipsc1.2", "msc1.2", "ipsc2.1", "msc2.1", "ipsc3.1", "msc3.1"), project = "ghousman")
gh_big_humans <- subset(gh_big, species == "Human")
gh_big_humans <- AddMetaData(gh_big_humans, "Ghousman", col.name = "orig.ident")
dim(gh_big_humans)

#Human Liver samples run through 10x (https://doi.org/10.1038/s41467-018-06318-7). This is a subset of the entire dataset, which is from whole liver homogenate. I used scViz to subset the data for clusters that were called hepatocytes in the original study (3490 cells)
liver <- readRDS("data/humanLiverSubset_hepatocytes.rds")
liver <- AddMetaData(liver, "Hepatocyte", col.name = "Cell.Type")
dim(liver)
```

![Cell Type Clusters from original paper](../analysis/figures/scviz1.png)
![Subsetting gate drawn in scViz](../analysis/figures/scviz2.png)

# Merge Datasets

Merge the seurat objects into one large one, keeping metadata about which study they originated in as well as their assigned cell type.

```{r merge}
#Merge, entering a "0" value for genes that are not in common
Combined <- merge(ANT1.2, y = c(chondro.seurat, gh_big_humans, liver), project = "Combined")

# merge based on common genes between ALL datasets
common.features <- Reduce(intersect, list(rownames(ANT1.2), rownames(chondro.seurat), rownames(gh_big_humans), rownames(liver)))
length(x = common.features)
Combined.common <- merge(ANT1.2[common.features, ], y = c(chondro.seurat[common.features, ], gh_big_humans[common.features, ], liver[common.features, ]), project = "Combined.common")
```





Now we can look at the cells in Seurat

```{r QC}
VlnPlot(Combined.common, features = c("nFeature_RNA", "nCount_RNA"), ncol = 2, group.by = "orig.ident")
VlnPlot(Combined.common, features = c("nFeature_RNA", "nCount_RNA"), ncol = 2, group.by = "Cell.Type")

# FeatureScatter is typically used to visualize feature-feature relationships, but can be used
# for anything calculated by the object, i.e. columns in object metadata, PC scores etc.

FeatureScatter(Combined.common, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
```


# Normalizing Data

```{r Norm}
Combined.common <- NormalizeData(Combined.common, normalization.method = "LogNormalize", scale.factor = 10000)
```


# Feature selection

```{r feature selection}
Combined.common <- FindVariableFeatures(Combined.common, selection.method = "vst", nfeatures = 2000)


plot_variable_features <- function(seurat.obj){
  # Identify the 10 most highly variable genes
  top10 <- head(VariableFeatures(seurat.obj), 10)
  
  # plot variable features with and without labels
  plot1 <- VariableFeaturePlot(seurat.obj) + 
       theme(legend.position="bottom")
  plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE) +
       theme(legend.position="bottom")
  return(CombinePlots(plots = list(plot1, plot2)))
}

plot_variable_features(Combined.common)
```

# Scaling Data

```{r scaling}
scale_data <- function(seurat.obj){
  all.genes <- rownames(seurat.obj)
  return(ScaleData(seurat.obj, features = all.genes, vars.to.regress = c("nUMI")))
}

Combined.common <- scale_data(Combined.common)
```

# Dimensionality Reduction

Using the highly variable features selected above, perform PCA

```{r PCA}
nPC <- 100
Combined.common <- RunPCA(Combined.common, features = VariableFeatures(object = Combined.common), npcs = nPC)


# Examine and visualize PCA results a few different ways
print(Combined.common[["pca"]], dims = 1:5, nfeatures = 5)
VizDimLoadings(Combined.common, dims = 1:2, reduction = "pca")

DimPlot(Combined.common, reduction = "pca", group.by = "Cell.Type")

# var explained by top 10 PCs
mat <- Seurat::GetAssayData(Combined.common, assay = "RNA", slot = "scale.data")
pca <- Combined.common[["pca"]]

# Get the total variance:
total_variance <- sum(matrixStats::rowVars(mat))

eigValues = (pca@stdev)^2  ## EigenValues
varExplained = eigValues / total_variance

DimHeatmap(Combined.common, dims = 1:15, cells = 500, balanced = TRUE)






#extract scaled data for highlyvargenes to a matrix outside of seurat to perform PCA and examine varexplained
source("code/PCA_fn.R")
library("RColorBrewer")
library("scales")

# Load colors 
colors <- colorRampPalette(c(brewer.pal(9, "Blues")[1],brewer.pal(9, "Blues")[9]))(100)
pal <- c(brewer.pal(9, "Set1"), brewer.pal(8, "Set2"), brewer.pal(12, "Set3"))

scaled <- Combined.common@assays$RNA@scale.data[VariableFeatures(Combined.common),]
dim(scaled)

pca_genes <- prcomp(t(scaled), scale = F)
scores <- pca_genes$x


### PCA Raw Data
for (n in 1:3){
     col.v <- pal[as.integer(factor(Combined.common@meta.data$labels))]
     plot_scores(pca_genes, scores, n, n+1, cols = col.v, legend = F, points = T)
}

#% Var explained by top 10 pcs
for(n in 1:10){
     print(n)
     print(summary(pca_genes)$importance[2,n]*100)
}


ElbowPlot(Combined.common, ndims = nPC) #50 PCs?
```


# Clustering

```{r clustering}
num_PCs <- 50

Combined.common <- FindNeighbors(Combined.common, dims = 1:num_PCs)
Combined.common <- FindClusters(Combined.common, resolution = 0.5)

#Run UMAP
Combined.common <- RunUMAP(Combined.common, dims = 1:num_PCs)
DimPlot(Combined.common, reduction = "umap", group.by = "Cell.Type")
```


```{r save}
# save reorganized sample information
saveRDS(Combined.common, "data/Combined_singlecell_data.rds")
```


# Grades of Membership analysis

```{r load_packages, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
library(CountClust)
library(maptpx)
library(ggplot2)
library(MAST)
library(RColorBrewer)
```

# Run CountClust::FitGoM on the data for k = 3:8
Make a function to run the CountClust::FitGoM function on the datasets.

```{r fitgom function}
runfitGoM <- function(datamatrix, tol = 0.1){
  listofks <- list()
  counter <- 1
  for(i in 3:8){
    listofks[[counter]] <- CountClust::FitGoM(datamatrix, K=i, tol = tol, control=list(tmax=100))
    counter <- counter + 1
  }
  return(listofks)
}
```

## Run the function.
First create a data matrix that only includes counts for highly variable genes and cells that passed the filter as determined by the Seurat functions above. Then run the GoM function on the data

```{r run the function on the datasets}
Combined_counts_filtered <- Combined.common@assays$RNA@counts[Combined.common@assays$RNA@var.features, colnames(Combined.common@assays$RNA@counts)]
dim(Combined_counts_filtered)
Combined_counts_filtered_celltypes <- Combined.common@meta.data$Cell.Type
length(Combined_counts_filtered_celltypes)

Combined_GoM <- runfitGoM(t(as.matrix(Combined_counts_filtered)))
```

# Analysis of the Topics within the Topic models generated for each dataset

Visualizations:

  visualizeGoM plots each cell based on the tSNE1 and tSNE2 embeddings. Colors are determmined based on assignment of each cell to a particular topic based on plurality membership (cells are colored by the topic that constitutes the largest proportion out of all the topics contributing to that cell).

  visualizeGoM_topic_gradients plots each cell based on the tSNE1 and tSNE2 embeddings. Separate plots are created for each topic. In each plot, cells are colored on a gradient according to the proportion of each cell contributed to by the topic.

  plot_structure_plot plots a stacked bar plot for each cell (separated into cell type categories determined by the authors) for the topics that contribute to each cell.

  plot_structure_plot_rare_only plots the same as above but removes the basal and club cell bar plots to allow for better visualization of the rare cell types.

  make_topic_plots plots separate boxplots for each topic. The y axis in each case is proportion contributed by the topic in question, and the x axis is faceted based on the cell types assigned to single cells by the authors.
  
```{r functions to visualize GoM}
visualizeGoM <- function(omega, seuratobject, data){
  omega <- omega[match(seuratobject@cell.names, colnames(data)),]
  labs_clus <- colnames(omega)[apply(omega,1,which.max)]
  data_ggplot <- data.frame(labels = labs_clus,
                          tSNE_1 = seuratobject@dr$tsne@cell.embeddings[, 1],
                          tSNE_2 = seuratobject@dr$tsne@cell.embeddings[, 2])
  plot1 <- ggplot(data_ggplot) + theme(panel.background = element_rect(colour = "black", size = 1),
                                     panel.grid.major = element_blank(),
                                     panel.grid.minor = element_blank(),
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(),
                                     axis.ticks = element_blank(),
                                     legend.text = element_text(size = 15)) + geom_point(aes(x = tSNE_1, y = tSNE_2, color = labels), size = 0.5) + labs(x = 'tSNE 1', y = 'tSNE 2', title = '') + scale_color_discrete('')
  return(plot1)
}

visualizeGoM_topic_gradients <- function(omega, seuratobject, data){
  omega <- omega[match(seuratobject@cell.names, colnames(data)),]
  ntopics <- ncol(omega)
  for (n in 1:ntopics){
  data_ggplot <- data.frame(proportion = omega[,n],
                          tSNE_1 = seuratobject@dr$tsne@cell.embeddings[, 1],
                          tSNE_2 = seuratobject@dr$tsne@cell.embeddings[, 2])
  plot.gradient <- ggplot(data_ggplot) + theme(panel.background = element_rect(colour = "black", size = 1),
                                     panel.grid.major = element_blank(),
                                     panel.grid.minor = element_blank(),
                                     axis.text.y = element_blank(),
                                     axis.text.x = element_blank(),
                                     axis.ticks = element_blank(),
                                     legend.text = element_text(size = 15)) + geom_point(aes(x = tSNE_1, y = tSNE_2, color = proportion), size = 0.5) + labs(x = 'tSNE 1', y = 'tSNE 2', title = '') + scale_colour_gradient(low="grey", high="red")
  plot(plot.gradient)
  }
}

plot_structure_plot <- function(omega, seuratobject){
  annotation <- data.frame(
    sample_id = rownames(omega),
    tissue_label = seuratobject@ident
    )
  my_color_palette1.1 <- brewer.pal(8, name = "Set2")
  my_color_palette1.2 <- brewer.pal(3, name = "Set3")
  my_color_palette1 <- c(my_color_palette1.1, my_color_palette1.2)
  StructureGGplot(omega = omega,
                annotation = annotation,
                palette = my_color_palette1,
                order_sample = TRUE,
                axis_tick = list(axis_ticks_length = .1,
                                 axis_ticks_lwd_y = .1,
                                 axis_ticks_lwd_x = .1,
                                 axis_label_size = 7,
                                 axis_label_face = "bold"))
}

plot_structure_plot_rare_only <- function(omega, seuratobject){
  annotation <- data.frame(
    sample_id = rownames(omega)[!(seuratobject@ident %in% c("Basal", "Club"))],
    tissue_label = seuratobject@ident[!(seuratobject@ident %in% c("Basal", "Club"))]
    )
  omega_rare <- omega[!(seuratobject@ident %in% c("Basal", "Club")),]
  my_color_palette1.1 <- brewer.pal(8, name = "Set2")
  my_color_palette1.2 <- brewer.pal(3, name = "Set3")
  my_color_palette1 <- c(my_color_palette1.1, my_color_palette1.2)
  StructureGGplot(omega = omega_rare,
                annotation = annotation,
                palette = my_color_palette1,
                order_sample = TRUE,
                axis_tick = list(axis_ticks_length = .1,
                                 axis_ticks_lwd_y = .1,
                                 axis_ticks_lwd_x = .1,
                                 axis_label_size = 7,
                                 axis_label_face = "bold"))
}

make_topic_plots <- function(omega, celltypes){
  omega <- as.data.frame(omega)
  omega <- cbind(omega,celltypes)
  for (k in 1:(ncol(omega)-1)) {
    base_plot <- ggplot(data = omega, mapping = aes(x = celltypes, y = omega[,k])) + labs(y = paste0("Topic ", k, " value"), x = paste0("Cell Type")) + theme(axis.text.x = element_text(angle = -20, hjust = 0, vjust = 0))
    plot(base_plot + geom_violin(width = 1.5, fill = "skyblue",color = "skyblue") +
      geom_boxplot(width = 0.1,outlier.shape = NA, alpha = 0.2))
   }
}
```

Use the CountClust::ExtractTopFeatures function to obtain KL measurement scores for the top 100 genes per cluster that best distinguish that cluster from the rest.

```{r cluster annotations function}
annotate_clusters <- function(theta_mat, countmatrix){
  top_features <- ExtractTopFeatures(theta_mat,
                                     top_features=100,
                                     method="poisson",
                                     options="min")
  gene_vector <- do.call(rbind, lapply(1:dim(top_features[[1]])[1], function(x) rownames(countmatrix)[top_features[[1]][x,]]))
  scores_vector <- do.call(rbind, lapply(1:dim(top_features[[1]])[1], function(x) top_features[[2]][x,]))
  print(gene_vector)
  print(scores_vector)
}
```

<!-- For the topic model fit to the threeprime dataset containing 7 topics,  -->

<!--   topic 1 seems to correspond to Basal cells,  -->

<!--   topic 2 seems to correspond to Club cells, -->

<!--   topic 3 seems to correspond to Ciliated cells,  -->

<!--   topic 4 seems to correspond to Goblet cells, -->

<!--   topic 5 seems to correspond to Tuft cells,  -->

<!--   topic 6 seems to correspond to Neuroendocrine cells, -->

<!--   topic 7 does not seem to correspond strongly to any cell type. -->
<!-- ```{r threeprime k of 7} -->
<!-- visualizeGoM(omega=threeprimeGoM[[6]]$fit$omega, seuratobject=threeprime_seurat, data=threeprime_counts_filtered) -->
<!-- visualizeGoM_topic_gradients(omega=threeprimeGoM[[6]]$fit$omega, seuratobject=threeprime_seurat, data=threeprime_counts_filtered) -->
<!-- plot_structure_plot(omega=threeprimeGoM[[6]]$fit$omega, seuratobject=threeprime_seurat) -->
<!-- plot_structure_plot_rare_only(omega=threeprimeGoM[[6]]$fit$omega, seuratobject=threeprime_seurat) -->
<!-- make_topic_plots(threeprimeGoM[[6]]$fit$omega, threeprime_counts_filtered_celltypes) -->
<!-- annotate_clusters(threeprimeGoM[[6]]$fit$theta, threeprime_counts_filtered) -->
<!-- ``` -->


<!-- # Visualizations for All values of k for each dataset -->
<!-- ## Visualize GoM clustering output -->
<!-- ### Visualize threeprime Dataset in tSNE plots, STRUCTURE plots, boxplots, and violin plots -->
<!-- ```{r visualize threeprime} -->
<!-- for (i in 3:length(threeprimeGoM)){ -->
<!--   plot(visualizeGoM(omega=threeprimeGoM[[i]]$fit$omega, seuratobject=threeprime_seurat, data=threeprime_counts_filtered)) -->
<!-- } -->
<!-- for (i in 3:length(threeprimeGoM)){ -->
<!--   visualizeGoM_topic_gradients(omega=threeprimeGoM[[i]]$fit$omega, seuratobject=threeprime_seurat, data=threeprime_counts_filtered) -->
<!-- } -->
<!-- for (i in 3:length(threeprimeGoM)){ -->
<!--   plot(plot_structure_plot(omega=threeprimeGoM[[i]]$fit$omega, seuratobject=threeprime_seurat)) -->
<!-- } -->
<!-- for (i in 3:length(threeprimeGoM)){ -->
<!--   plot(plot_structure_plot_rare_only(omega=threeprimeGoM[[i]]$fit$omega, seuratobject=threeprime_seurat)) -->
<!-- } -->
<!-- for (i in 3:length(threeprimeGoM)){ -->
<!--   j <- i + 1 -->
<!--   print(paste0("Plots for ThreePrime k = ", j)) -->
<!--   make_topic_plots(threeprimeGoM[[i]]$fit$omega, threeprime_counts_filtered_celltypes) -->
<!-- } -->
<!-- ``` -->


<!-- ## Cluster annotations -->
<!-- ### Top 100 Genes Driving Clusters in the threeprime Dataset  -->
<!-- ```{r visualize threeprime genes} -->
<!-- annotate_clusters(threeprimeGoM[[3]]$fit$theta, threeprime_counts_filtered) -->
<!-- annotate_clusters(threeprimeGoM[[4]]$fit$theta, threeprime_counts_filtered) -->
<!-- annotate_clusters(threeprimeGoM[[5]]$fit$theta, threeprime_counts_filtered) -->
<!-- annotate_clusters(threeprimeGoM[[6]]$fit$theta, threeprime_counts_filtered) -->
<!-- annotate_clusters(threeprimeGoM[[7]]$fit$theta, threeprime_counts_filtered) -->
<!-- annotate_clusters(threeprimeGoM[[8]]$fit$theta, threeprime_counts_filtered) -->
<!-- annotate_clusters(threeprimeGoM[[9]]$fit$theta, threeprime_counts_filtered) -->
<!-- ``` -->
