---
title: "cell Atlas Assignments"
author: "Anthony Hung"
date: "2020-01-24"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction

# Load correlation functions

```{r load functions}
library(Seurat)

#load correlation functions
source("code/cellAtlas_assignment.R")

#load single-cell data from pilot
ANT1.2 <- readRDS("data/ANT1_2.rds")

```

# Apply functions to single cell data to label them with assigned cell type

```{r assign metadata}
#Compute the correlation matrix use a seurat object and cell line matrix as input
cor.mat <- ComputeCorMat(ANT1.2,cell.line)
head(cor.mat)

#Add a metadata column "clusteredCellAtlas" to the object
ANT1.2 <- AssignClusteredLabel(ANT1.2,cor.mat, K=25, topCorrelation=5)

#Table of assigned cell labels
table(ANT1.2$clusteredCellAtlas)
```

# Exploring different values of K (clusters of cellatlas populations)

Out of interest, I look at how trying different resolutions of the cellatlas data affect assignments of cell types

```{r try K}
for(kval in 11:95){
     print(kval)
     print(table(AssignClusteredLabel(ANT1.2,cor.mat, K=kval, topCorrelation=5)$clusteredCellAtlas))
}

```


# Crude analyses of correlation matrix

```{r crude}
# see which cell lines are highest correlated (sum over all cells) in the data with the summed values
colSums(cor.mat)[colSums(cor.mat) > 800]

```

# clustering Analysis of cell atlas data (PCA)

```{r clustering of cell atlas alone}
library("ggplot2")
library("ggfortify")

# Perform PCA
pca_genes <- prcomp(t(cell.line), scale = T)

#relabel cell.line with cell types
cell.line.relabeled <- as.data.frame(t(cell.line))
cell.line.relabeled$celltype <- sapply(strsplit(as.character(rownames(cell.line.relabeled)), "\\_"), "[[", 2)
rownames(cell.line.relabeled) <- paste0(sapply(strsplit(as.character(rownames(cell.line.relabeled)), "\\_"), "[[", 1), " ", sapply(strsplit(as.character(rownames(cell.line.relabeled)), "\\_"), "[[", 2))

#Make PCA plots

autoplot(pca_genes, data = cell.line.relabeled, colour = 'celltype')
autoplot(pca_genes, data = cell.line.relabeled, colour = 'celltype', label=T)





#Trying PCA after removing spermatocyte
cell.line.sperm <- cell.line[, -95]
# Perform PCA
pca_genes.sperm <- prcomp(t(cell.line.sperm), scale = T)

#relabel cell.line with cell types
cell.line.sperm.relabeled <- as.data.frame(t(cell.line.sperm))
cell.line.sperm.relabeled$celltype <- sapply(strsplit(as.character(rownames(cell.line.sperm.relabeled)), "\\_"), "[[", 2)
rownames(cell.line.sperm.relabeled) <- paste0(sapply(strsplit(as.character(rownames(cell.line.sperm.relabeled)), "\\_"), "[[", 1), " ", sapply(strsplit(as.character(rownames(cell.line.sperm.relabeled)), "\\_"), "[[", 2))

#Make PCA plots

autoplot(pca_genes.sperm, data = cell.line.sperm.relabeled, colour = 'celltype')
autoplot(pca_genes.sperm, data = cell.line.sperm.relabeled, colour = 'celltype', label=T) + theme(legend.position = "none")
autoplot(pca_genes.sperm, data = cell.line.sperm.relabeled, colour = 'celltype', label=T, x=2, y=3) + theme(legend.position = "none")
autoplot(pca_genes.sperm, data = cell.line.sperm.relabeled, colour = 'celltype', label=T, x=3, y=4) + theme(legend.position = "none")

```

# clustering Analysis of cell atlas data (Corr Heatmap)

```{r corr heatmap}
library("gplots")
library("RColorBrewer")
library("scales")
# Load colors 
colors <- colorRampPalette(c(brewer.pal(9, "Blues")[1],brewer.pal(9, "Blues")[9]))(100)
pal <- c(brewer.pal(9, "Set1"), brewer.pal(8, "Set2"), brewer.pal(12, "Set3"))


#Corr heatmap
cors <- cor(cell.line, method="spearman", use="pairwise.complete.obs")
heatmap.2(cors, scale="none", col = colors, margins = c(12, 12), trace='none', denscol="white", labCol=cell.line.relabeled$celltype,
          ColSideColors=pal[as.integer(as.factor(cell.line.relabeled$celltype))],
          RowSideColors=pal[as.integer(as.factor(cell.line.relabeled$celltype))],
          cexCol = 0.1 + 1/log10(15), cexRow = 0.1 + 1/log10(15))

```

