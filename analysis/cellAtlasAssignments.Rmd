---
title: "cell Atlas or Human Cell Landscape Assignments"
author: "Anthony Hung"
date: "2020-01-24"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Introduction

# Cell atlas from Mengie Chen's lab (UChicago)
Compute correlation between reference set of samples and individual cells (input is seurat object.)
Load correlation functions

```{r load functions}
library(Seurat)

#load correlation functions
source("code/cellAtlas_assignment.R")

#load single-cell data from pilot
#ANT1.2 <- readRDS("data/ANT1_2.rds")
SCT_integrated <- readRDS("data/SCT_ANT12_integrated.rds")
```

## Apply functions to single cell data to label them with assigned cell type

```{r assign metadata}
#Compute the correlation matrix use a seurat object (COUNTS) and cell line matrix as input
DefaultAssay(SCT_integrated) <- "RNA"
cor.mat <- ComputeCorMat(SCT_integrated,cell.line)
head(cor.mat)

#Add a metadata column "clusteredCellAtlas" to the object
SCT_integrated <- AssignClusteredLabel(SCT_integrated,cor.mat, K=20, topCorrelation=5)

#Table of assigned cell labels
table(SCT_integrated$clusteredCellAtlas)
```

## Exploring different values of K (clusters of cellatlas populations)

Out of interest, I look at how trying different resolutions of the cellatlas data affect assignments of cell types

```{r try K}
for(kval in 11:95){
     print(kval)
     print(table(AssignClusteredLabel(SCT_integrated,cor.mat, K=kval, topCorrelation=5)$clusteredCellAtlas))
}

```


## Crude analyses of correlation matrix

```{r crude}
# see which cell lines are highest correlated (sum over all cells) in the data with the summed values
colSums(cor.mat)[colSums(cor.mat) > 800]

```

## clustering Analysis of cell atlas data (PCA)

```{r clustering of cell atlas alone}
library("ggplot2")
library("ggfortify")

# Perform PCA
pca_genes <- prcomp(t(cell.line), scale = T)

#relabel cell.line with cell types
cell.line.relabeled <- as.data.frame(t(cell.line))
cell.line.relabeled$celltype <- sapply(strsplit(as.character(rownames(cell.line.relabeled)), "\\_"), "[[", 2)
rownames(cell.line.relabeled) <- paste0(sapply(strsplit(as.character(rownames(cell.line.relabeled)), "\\_"), "[[", 1), " ", sapply(strsplit(as.character(rownames(cell.line.relabeled)), "\\_"), "[[", 2))

#Make PCA plots

autoplot(pca_genes, data = cell.line.relabeled, colour = 'celltype')
autoplot(pca_genes, data = cell.line.relabeled, colour = 'celltype', label=T)





#Trying PCA after removing spermatocyte
cell.line.sperm <- cell.line[, -95]
# Perform PCA
pca_genes.sperm <- prcomp(t(cell.line.sperm), scale = T)

#relabel cell.line with cell types
cell.line.sperm.relabeled <- as.data.frame(t(cell.line.sperm))
cell.line.sperm.relabeled$celltype <- sapply(strsplit(as.character(rownames(cell.line.sperm.relabeled)), "\\_"), "[[", 2)
rownames(cell.line.sperm.relabeled) <- paste0(sapply(strsplit(as.character(rownames(cell.line.sperm.relabeled)), "\\_"), "[[", 1), " ", sapply(strsplit(as.character(rownames(cell.line.sperm.relabeled)), "\\_"), "[[", 2))

#Make PCA plots

autoplot(pca_genes.sperm, data = cell.line.sperm.relabeled, colour = 'celltype')
autoplot(pca_genes.sperm, data = cell.line.sperm.relabeled, colour = 'celltype', label=T) + theme(legend.position = "none")
autoplot(pca_genes.sperm, data = cell.line.sperm.relabeled, colour = 'celltype', label=T, x=2, y=3) + theme(legend.position = "none")
autoplot(pca_genes.sperm, data = cell.line.sperm.relabeled, colour = 'celltype', label=T, x=3, y=4) + theme(legend.position = "none")

```

## clustering Analysis of cell atlas data (Corr Heatmap)

```{r corr heatmap}
library("gplots")
library("RColorBrewer")
library("scales")
# Load colors 
colors <- colorRampPalette(c(brewer.pal(9, "Blues")[1],brewer.pal(9, "Blues")[9]))(100)
pal <- c(brewer.pal(9, "Set1"), brewer.pal(8, "Set2"), brewer.pal(12, "Set3"))


#Corr heatmap
cors <- cor(cell.line, method="spearman", use="pairwise.complete.obs")
heatmap.2(cors, scale="none", col = colors, margins = c(12, 12), trace='none', denscol="white", labCol=cell.line.relabeled$celltype,
          ColSideColors=pal[as.integer(as.factor(cell.line.relabeled$celltype))],
          RowSideColors=pal[as.integer(as.factor(cell.line.relabeled$celltype))],
          cexCol = 0.1 + 1/log10(15), cexRow = 0.1 + 1/log10(15))

```



# Human cell Landscape (http://bis.zju.edu.cn/HCL/blast.html)

This is a similar method, but uses DGE objects and a different reference set (the reference set comes from single cell rather than bulk data). Computes correlations between cells in a test sample and the reference set samples and assigns best correlation identity.

```{r HCL prep}
#This require devtools  
#install.packages('devtools')
#library(devtools)
# scHCL requires ggplot2/reshape2/plotly/shiny/shinythemes/shiny
#install_github("ggjlab/scHCL")
library(scHCL)
library(Seurat)
library(scran)
```

Convert to DGE (Keep all genes and use raw unnormalized counts).

```{r DGE}
metadata <- SCT_integrated@meta.data # keep metadata handy
sce <- as.SingleCellExperiment(SCT_integrated, assay="RNA")
dge<- convertTo(sce, type= "edgeR")
remove(sce)
dge$samples<- cbind(dge$samples, metadata)
```

Run scHCL and visualize

```{r hcl_result}
hcl_result <- scHCL(scdata = dge$counts, numbers_plot = 3)
scHCL_vis(hcl_result)
```

