---
title: "Bulk_cellComposition_analysis"
author: "Anthony Hung"
date: "2020-01-28"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Cluster pilot Bulk RNA data with subset of cellAtlas bulk data and other data to determine where my samples fall in comparison

## Load data

```{r load}
library("RColorBrewer")
library("scales")
library("cowplot")
library("CountClust")
library("maptpx")
library("MAST")
library("ggplot2")
library("ggfortify")
library("gplots")

# load gene annotations
gene_anno <- read.delim("data/gene-annotation.txt",
                        sep = "\t")

# Load colors 
colors <- colorRampPalette(c(brewer.pal(9, "Blues")[1],brewer.pal(9, "Blues")[9]))(100)
pal <- c(brewer.pal(9, "Set1"), brewer.pal(8, "Set2"), brewer.pal(12, "Set3"))

#load cell atlas data matrix
load("data/cell_atlas_ref_panel")
cell.line <- cell.line[,c(12:20,35,36,40,55:57)]

#load pilot data
raw_counts <- as.matrix(readRDS("data/raw_counts_relabeled.rds"))

# load gene annotations
gene_anno <- read.delim("data/gene-annotation.txt",
                        sep = "\t")

#relabel pilot data genes to symbols
pilot <- raw_counts
rownames(pilot) <- gene_anno$external_gene_name[match(unlist(rownames(pilot)), gene_anno$ensembl_gene_id)]
```

## Before combining the datasets, I apply the same standardizations/normalizations performed on the cellAtlas data to my pilot data

```{r normalize}
#perform normalizations (taken from cellAtlas_assignment.R code)
pilot_norm <- apply(pilot, 2, function(x) x/sum(x))
pilot_libsize <- apply(pilot_norm, 2, function(x) x * 1e+06)
Data.use <- pilot_libsize

#Only include genes that are common between the two data sets
gene.id <- rownames(Data.use)
gene.ref <- rownames(cell.line)
common <- intersect(gene.id, gene.ref)
print(paste0("There are ", length(common), " genes in common between the two sets"))
logxx <- apply(Data.use[common, ], 2, function(x) {
        log(x + 0.1)
    })
selected.cell.line <- apply(cell.line[common, ], 2, function(x) {
        x - mean(x)
    })
```

## Combine the two datasets into one matrix

```{r combine}
combined <- cbind(logxx, selected.cell.line)
```

## Clustering (PCA)

```{r PCA cell atlas}
# Perform PCA
pca_genes <- prcomp(t(combined), scale = T)

#Make PCA plots 

autoplot(pca_genes, label = T)
```

## Clustering (corr heatmap)

```{r corr heatmap}
#Corr heatmap
cors <- cor(combined, method="spearman", use="pairwise.complete.obs")
heatmap.2(cors, scale="none", margins = c(12, 12), trace='none', denscol="white",
          cexCol = 0.1 + 1/log10(15), cexRow = 0.1 + 1/log10(15))
```


# Outside data analysis

Compare pilot bulk data with bulk data collected from iPSCs, MSCs, chondrocytes from OA patients, and heart tissue (note: I have only used a Single read from each sample and trimmed to the first 50 bases to ensure that there are not mapping biases between samples). Here, I try both upperquartile and RLE normalization methods

```{r load outside}
# load in counts
outside_data_counts <- read.table("/project2/gilad/anthonyhung/Projects/OAStrain_project/bulkRNAseq_outsideData/out/counts/counts.txt", header = T)

# assign row.names
row.names(outside_data_counts) <- outside_data_counts$Geneid

# exclude extra data columns
outside_data_counts <- outside_data_counts[, -c(1:6)]

#rename samples (colnames)
# SRR_details <- read.csv("data/SRRdetails_for_outsideData.csv")
# sample_names <- names(outside_data_counts)
# label_vector <- c(rep(0, length(sample_names)))
# for(i in SRR_details$Sample.ID){
#      location <- grepl(i, sample_names)
#      label_vector[location] <- SRR_details$Label[location]
# }
# label_vector
# names(outside_data_counts) <- SRR_details$Label[label_vector]
names(outside_data_counts) <- c("MSC-Chond-d3_3", "Heart_2", "Chond_TCP_P4_2", "Chond_SCM_P4_3", "MSC-Chond-d21_3", 
                                "Chond_SCM_P4_1", "MSC-Chond-d1_3", "MSC-Chond-d0_3", "MSC-Chond-d0_1", "MSC-Chond-d0_2", 
                                "Heart_3", "Lung_3", "Lung_2", "Chond_TCP_P1_1", "MSC-Chond-d7_2",
                                "iPSC-MSC9_1", "Liver_2", "MSC-Chond-d3_1", "Kidney_4", "OA_dmg_3", 
                                "Kidney_1", "bmMSC_1.1", "iPSC-MSC5_1", "OA_intact_1", "bmMSC_2.1",
                                "Liver_1", "iPSC-MSC5_2", "Chond_SCM_P1_2", "Chond_TCP_P4_3", "MSC-Chond-d14_2", 
                                "MSC-Chond-d3_2", "iPSC_2", "Chond_TCP_P1_2", "MSC-Chond-d14_3", "Lung_4", 
                                "OA_intact_2", "MSC-Chond-d21_1", "OA_dmg_2", "adMSC", "Heart_1", 
                                "Kidney_2", "OA_intact_3", "bmMSC_2.2", "Chond_SCM_P4_2", "Chond_SCM_P1_1", 
                                "MSC-Chond-d1_2", "MSC-Chond-d1_1", "Lung_1", "MSC-Chond-d7_1", "iPSC-MSC9_2", 
                                "Kidney_3", "OA_dmg_1", "Chond_TCP_P4_1", "bmMSC_1.3", "Chond_TCP_P1_3", 
                                "Liver_3", "MSC-Chond-d14_1", "Heart_4", "MSC-Chond-d7_3", "Chond_SCM_P1_3", 
                                "iPSC_1", "MSC-Chond-d21_2", "bmMSC_1.2", "Liver_4")

#remove MSC-chond samples and OA samples
MSC_chond_samples <- c(1,5,7:10,15,18,30:31,34,37,46:47,49,57,59,62)
OA_samples <- c(20,24,36,38,42,52)
outside_data_counts<- outside_data_counts[,-c(MSC_chond_samples, OA_samples)]

#Combine all bulk data together
merged_raw_data <- merge(raw_counts, outside_data_counts, by = "row.names")
row.names(merged_raw_data) <- merged_raw_data$Row.names
merged_raw_data <- merged_raw_data[,-1]

#Remove rows with all 0s
dim(merged_raw_data)
merged_raw_data <- merged_raw_data[apply(merged_raw_data, 1, function(x) !all(x==0)),]
dim(merged_raw_data)
```

## Raw counts analysis

```{r raw analysis}
# Perform PCA
pca_genes <- prcomp(t(data.matrix(merged_raw_data)), scale = T)

#Make PCA plots 
autoplot(pca_genes, label = T)


#Corr heatmap
cors <- cor(merged_raw_data, method="spearman", use="pairwise.complete.obs")

labels <- sapply(strsplit(colnames(merged_raw_data),"_"), `[`, 1)

heatmap.2( cors, scale="none", col = colors, margins = c(12, 12), trace='none', denscol="white", labCol=labels, ColSideColors=pal[as.integer(as.factor(labels))], RowSideColors=pal[as.integer(as.factor(labels))], cexCol = 0.2 + 1/log10(15), cexRow = 0.2 + 1/log10(15))
```

## Normalize raw merged counts: upperquartile Normalization

```{r upperquartile normalization}
library(edgeR)
merged_raw_data <- DGEList(merged_raw_data, group = colnames(merged_raw_data))
upperquartile <- calcNormFactors(merged_raw_data, method = "upperquartile")
upperquartile <- cpm(upperquartile, log=TRUE, normalized.lib.sizes = T)
head(upperquartile)

# Look at density plots
plotDensities(upperquartile, legend="topright")
```

## Correlation heatmap of log2upperquartile normalized and unfiltered samples

```{r corr heatmap unfiltered upperquartile}
cors <- cor(upperquartile, method="spearman", use="pairwise.complete.obs")

labels <- sapply(strsplit(colnames(merged_raw_data),"_"), `[`, 1)

heatmap.2( cors, scale="none", col = colors, margins = c(12, 12), trace='none', denscol="white", labCol=labels, ColSideColors=pal[as.integer(as.factor(labels))], RowSideColors=pal[as.integer(as.factor(labels))], cexCol = 0.2 + 1/log10(15), cexRow = 0.2 + 1/log10(15))
```

## Boxplots of upperquartile across samples

```{r boxplot upperquartile}
library(reshape2)
meltupperquartile <- melt(upperquartile)
names(meltupperquartile) <- c("gene", "sampleID", "upperquartile")
p <- ggplot(meltupperquartile, aes(factor(sampleID), upperquartile)) 
p + geom_boxplot() + theme(axis.text.x = element_text(angle = 90))
```

## Filtering for lowly expressed genes (avg log2upperquartile > 2 in at least 10 samples)

```{r filter upperquartile}
cutoff <- 2

keep <- rowSums( upperquartile > cutoff ) >= 10

counts_upperquartile <- merged_raw_data[keep,]
filtered_upperquartile <- upperquartile[keep,]
dim(filtered_upperquartile)
```

## Boxplots of normalized+filtered counts across samples

```{r boxplot filt upperquartile}
melt_filt_upperquartile <- melt(filtered_upperquartile)
names(melt_filt_upperquartile) <- c("gene", "sampleID", "log2upperquartile")
p1 <- ggplot(melt_filt_upperquartile, aes(factor(sampleID), log2upperquartile)) 
p1 + geom_boxplot() + theme(axis.text.x = element_text(angle = 90))

plotDensities(filtered_upperquartile, legend = F)
```

## Correlation heatmap of log2upperquartile normalized and filtered samples

```{r corr heatmap filtered upperquartile}
cors <- cor(filtered_upperquartile, method="spearman", use="pairwise.complete.obs")

labels <- sapply(strsplit(colnames(merged_raw_data),"_"), `[`, 1)

heatmap.2( cors, scale="none", col = colors, margins = c(12, 12), trace='none', denscol="white", labCol=labels, ColSideColors=pal[as.integer(as.factor(labels))], RowSideColors=pal[as.integer(as.factor(labels))], cexCol = 0.2 + 1/log10(15), cexRow = 0.2 + 1/log10(15))
```

## PCA of log2upperquartile normalized and filtered samples

```{r PCA quartile}
# Perform PCA
pca_genes <- prcomp(t(data.matrix(filtered_upperquartile)), scale = T)

#Make PCA plots 
autoplot(pca_genes, label = T)
```







## Normalize raw merged counts: RLE Normalization

```{r RLE normalization}
library(edgeR)
merged_raw_data <- DGEList(merged_raw_data, group = colnames(merged_raw_data))
RLE <- calcNormFactors(merged_raw_data, method = "RLE")
RLE <- cpm(RLE, log=TRUE, normalized.lib.sizes = T)
head(RLE)

# Look at density plots
plotDensities(RLE, legend="topright")
```

## Correlation heatmap of log2RLE normalized and unfiltered samples

```{r corr heatmap unfiltered RLE}
cors <- cor(RLE, method="spearman", use="pairwise.complete.obs")

labels <- sapply(strsplit(colnames(merged_raw_data),"_"), `[`, 1)

heatmap.2( cors, scale="none", col = colors, margins = c(12, 12), trace='none', denscol="white", labCol=labels, ColSideColors=pal[as.integer(as.factor(labels))], RowSideColors=pal[as.integer(as.factor(labels))], cexCol = 0.2 + 1/log10(15), cexRow = 0.2 + 1/log10(15))
```

## Boxplots of RLE across samples

```{r boxplot RLE}
library(reshape2)
meltRLE <- melt(RLE)
names(meltRLE) <- c("gene", "sampleID", "RLE")
p <- ggplot(meltRLE, aes(factor(sampleID), RLE)) 
p + geom_boxplot() + theme(axis.text.x = element_text(angle = 90))
```

## Filtering for lowly expressed genes (avg log2RLE > 2 in at least 10 samples)

```{r filter RLE}
cutoff <- 2

keep <- rowSums( RLE > cutoff ) >= 10

counts_RLE <- merged_raw_data[keep,]
filtered_RLE <- RLE[keep,]
dim(filtered_RLE)
```

## Boxplots of normalized+filtered counts across samples

```{r boxplot filt RLE}
melt_filt_RLE <- melt(filtered_RLE)
names(melt_filt_RLE) <- c("gene", "sampleID", "log2RLE")
p1 <- ggplot(melt_filt_RLE, aes(factor(sampleID), log2RLE)) 
p1 + geom_boxplot() + theme(axis.text.x = element_text(angle = 90))

plotDensities(filtered_RLE, legend = F)
```

## Correlation heatmap of log2RLE normalized and filtered samples

```{r corr heatmap filtered RLE}
cors <- cor(filtered_RLE, method="spearman", use="pairwise.complete.obs")

labels <- sapply(strsplit(colnames(merged_raw_data),"_"), `[`, 1)

heatmap.2( cors, scale="none", col = colors, margins = c(12, 12), trace='none', denscol="white", labCol=labels, ColSideColors=pal[as.integer(as.factor(labels))], RowSideColors=pal[as.integer(as.factor(labels))], cexCol = 0.2 + 1/log10(15), cexRow = 0.2 + 1/log10(15))
```

## PCA of log2RLE normalized and filtered samples

```{r PCA}
# Perform PCA
pca_genes <- prcomp(t(data.matrix(filtered_RLE)), scale = T)

#Make PCA plots 
autoplot(pca_genes, label = T)
```

# Grade of Membership analysis

```{r gom}
merged_raw_data_counts <- merged_raw_data$counts
Combined_counts_celltypes <- sapply(strsplit(as.character(counts_upperquartile$samples$group),"_"), `[`, 1)

#Choosing between values of k
Combined_GoM <- CountClust::FitGoM(t(merged_raw_data_counts), K=c(2:20), tol = 0.1, control=list(tmax=100))
#choosing between k
comparisons <- compGoM(data = t(merged_raw_data_counts), model = Combined_GoM)
plot(cbind(comparisons[1,], c(2:20)))
plot(cbind(comparisons[2,], c(2:20)))
```


```{r plotting GoM}
plot_structure_plot <- function(omega, labels){
     annotation <- data.frame(
          sample_id = paste0("X", c(1:NROW(omega))),
          tissue_label = labels
          )
     rownames(omega) <- annotation$sample_id
     StructureGGplot(omega = omega,
                     annotation = annotation,
                     order_sample = TRUE,
                     axis_tick = list(axis_ticks_length = .1,
                                      axis_ticks_lwd_y = .1,
                                      axis_ticks_lwd_x = .1,
                                      axis_label_size = 7,
                                      axis_label_face = "bold")
                     )
     }


make_topic_plots <- function(omega, labels){
  omega <- as.data.frame(omega)
  omega <- cbind(omega,labels)
  for (k in 1:(ncol(omega)-1)) {
    base_plot <- ggplot(data = omega, mapping = aes(x = labels, y = omega[,k])) + labs(y = paste0("Topic ", k, " value"), x = paste0("Cell Type")) + theme(axis.text.x = element_text(angle = -20, hjust = 0, vjust = 0))
    plot(base_plot + geom_violin(width = 1.5, fill = "skyblue",color = "skyblue") +
      geom_boxplot(width = 0.1,outlier.shape = NA, alpha = 0.2))
   }
}

annotate_clusters <- function(theta_mat, countmatrix){
  top_features <- ExtractTopFeatures(theta_mat,
                                     top_features=100,
                                     method="poisson",
                                     options="min")
  gene_vector <- do.call(rbind, lapply(1:dim(top_features[[1]])[1], function(x) rownames(countmatrix)[top_features[[1]][x,]]))
  scores_vector <- do.call(rbind, lapply(1:dim(top_features[[1]])[1], function(x) top_features[[2]][x,]))
  return(list(gene_vector, scores_vector))
}


labels <- sapply(strsplit(colnames(merged_raw_data_counts),"_"), `[`, 1)

# k = 4
plot_structure_plot(omega = Combined_GoM$clust_4$omega, labels = labels)
make_topic_plots(omega = Combined_GoM$clust_4$omega, labels = labels)
genes <- annotate_clusters(theta_mat = Combined_GoM$clust_4$theta, countmatrix = merged_raw_data_counts)
matrix(gene_anno$external_gene_name[match(genes[[1]], gene_anno$ensembl_gene_id)], ncol = 100)
genes[[2]]

# k = 5
plot_structure_plot(omega = Combined_GoM$clust_5$omega, labels = labels)
make_topic_plots(omega = Combined_GoM$clust_5$omega, labels = labels)
genes <- annotate_clusters(theta_mat = Combined_GoM$clust_5$theta, countmatrix = merged_raw_data_counts)
matrix(gene_anno$external_gene_name[match(genes[[1]], gene_anno$ensembl_gene_id)], ncol = 100)
genes[[2]]

# k = 6
plot_structure_plot(omega = Combined_GoM$clust_6$omega, labels = labels)
make_topic_plots(omega = Combined_GoM$clust_6$omega, labels = labels)
genes <- annotate_clusters(theta_mat = Combined_GoM$clust_6$theta, countmatrix = merged_raw_data_counts)
matrix(gene_anno$external_gene_name[match(genes[[1]], gene_anno$ensembl_gene_id)], ncol = 100)
genes[[2]]

# k = 7
plot_structure_plot(omega = Combined_GoM$clust_7$omega, labels = labels)
make_topic_plots(omega = Combined_GoM$clust_7$omega, labels = labels)
genes <- annotate_clusters(theta_mat = Combined_GoM$clust_7$theta, countmatrix = merged_raw_data_counts)
matrix(gene_anno$external_gene_name[match(genes[[1]], gene_anno$ensembl_gene_id)], ncol = 100)
genes[[2]]

# k = 8
plot_structure_plot(omega = Combined_GoM$clust_8$omega, labels = labels)
make_topic_plots(omega = Combined_GoM$clust_8$omega, labels = labels)
genes <- annotate_clusters(theta_mat = Combined_GoM$clust_8$theta, countmatrix = merged_raw_data_counts)
matrix(gene_anno$external_gene_name[match(genes[[1]], gene_anno$ensembl_gene_id)], ncol = 100)
genes[[2]]
```

# Check expression of chondrocyte markers across data

```{r chond markers}
#Inputs: count matrix, sample information data frame, and gene of interest in the ENSG format
get_gene_long <- function(counts, info, gene){
     gene_counts <- as.data.frame(counts[gene,])
     names(gene_counts) <- "norm_expr"
     gene_counts_info <- cbind(gene_counts, info)
     return(gene_counts_info)
}

boxplot_gene_sample_type <- function(counts_, info_, gene_, name, y_axis = "log2 Normalized Expression"){
     df <- get_gene_long(counts = counts_, info = info_, gene = gene_)
     
     ggplot(df, aes(x = labels, y = norm_expr, color = labels)) +
          geom_boxplot() +
          labs(title=paste0("Expression of ", as.character(name), " by sample type"), x= "Sample Type", y = y_axis)
}



labels <- sapply(strsplit(colnames(merged_raw_data),"_"), `[`, 1)

#SOX9
boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000125398", "SOX9")
#COL11A1
boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000060718", "COL11A1")
#SOX5
boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000134532", "SOX5")
#SOX6
boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000110693", "SOX6")
#TGFB3
boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000119699", "TGFB3")

#COL2A1
boxplot_gene_sample_type(merged_raw_data$counts, labels, "ENSG00000139219", "COL2A1", y_axis = "Raw counts")
#ACAN
boxplot_gene_sample_type(merged_raw_data$counts, labels, "ENSG00000157766", "ACAN", y_axis = "Raw counts")
```

# Check expression of GoM cluster markers across data

For k = 4

```{r cluster markers}
# # cluster 1
# 
# #COL3A1
# boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000168542", "COL3A1")
# #COL1A2
# boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000164692", "COL1A2")
# #COL1A1
# boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000108821", "COL1A1")
# #SPARC
# boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000113140", "SPARC")
# #FN1
# boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000115414", "FN1")
# 
# # cluster 2
# 
# #IGFBP3
# boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000146674", "IGFBP3")
# #EFEMP1
# boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000115380", "EFEMP1")
# #BGN
# boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000182492", "BGN")
# #AHNAK
# boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000124942", "AHNAK")
# #HAPLN1
# boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000145681", "HAPLN1")
# 
# 
# 
# # cluster 3
# 
# #SERPINA1
# boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000197249", "SERPINA1")
# #CTSV
# boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000136943", "CTSV")
# #KRT8
# boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000170421", "KRT8")
# #KRT19
# boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000171345", "KRT19")
# #APOE
# boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000130203", "APOE")
# 
# 
# # Cluster 4 (although is the representation of MT genes worrisome?)
# #TTN
# boxplot_gene_sample_type(filtered_RLE, labels, "ENSG00000155657", "TTN")
```

# Semi-supervised topic modeling (define some known clusters prior to fitting topic model)

```{r supervised}
library("classtpx")

# labels for "known" clusters
index_heart <- which(labels=="Heart")
index_lung <- which(labels=="Lung")
index_liver <- which(labels=="Liver")
index_kidney <- which(labels=="Kidney")
index_iPSC <- which(labels=="iPSC")
index_chond <- which(labels=="Chond")

known_samples <- c(index_heart, index_lung, index_liver, index_kidney, index_iPSC, index_chond)

class_labs <- c(rep("Heart", length(index_heart)),
                rep("Lung", length(index_lung)),
                rep("Liver", length(index_liver)),
                rep("Kidney", length(index_kidney)),
                rep("iPSC", length(index_iPSC)),
                rep("Chond", length(index_chond))
                )

# Perform topic modeling k=6
if (file.exists("data/merged_topic_fit_6_classtpx_omega_fix.rda")){
     Topic_clus_6 <- get(load(file="data/merged_topic_fit_6_classtpx_omega_fix.rda"))
} else {
Topic_clus_6 <- classtpx::class_topics(
    t(merged_raw_data_counts),
    K=6,
    known_samples = known_samples,
    class_labs = class_labs,
    method="omega.fix",
    tol=0.01)
save(Topic_clus_6, file="data/merged_topic_fit_6_classtpx_omega_fix.rda")
}

omega <- Topic_clus_6$omega
annotation <- data.frame(
  sample_id = paste0("X", c(1:NROW(omega))),
  tissue_label = as.factor(labels))
rownames(omega) <- annotation$sample_id
CountClust::StructureGGplot(omega = omega,
                annotation = annotation,
                palette = RColorBrewer::brewer.pal(8, "Accent"),
                yaxis_label = "Tissue Type",
                order_sample = TRUE,
                axis_tick = list(axis_ticks_length = .1,
                                 axis_ticks_lwd_y = .1,
                                 axis_ticks_lwd_x = .1,
                                 axis_label_size = 7,
                                 axis_label_face = "bold")
                )




# Perform topic modeling k=7
if (file.exists("data/merged_topic_fit_7_classtpx_omega_fix.rda")){
     Topic_clus_7 <- get(load(file="data/merged_topic_fit_7_classtpx_omega_fix.rda"))
} else {
Topic_clus_7 <- classtpx::class_topics(
    t(merged_raw_data_counts),
    K=7,
    known_samples = known_samples,
    class_labs = class_labs,
    method="omega.fix",
    tol=0.01)
save(Topic_clus_7, file="data/merged_topic_fit_7_classtpx_omega_fix.rda")
}

omega <- Topic_clus_7$omega
annotation <- data.frame(
  sample_id = paste0("X", c(1:NROW(omega))),
  tissue_label = as.factor(labels))
rownames(omega) <- annotation$sample_id
CountClust::StructureGGplot(omega = omega,
                annotation = annotation,
                palette = RColorBrewer::brewer.pal(8, "Accent"),
                yaxis_label = "Tissue Type",
                order_sample = TRUE,
                axis_tick = list(axis_ticks_length = .1,
                                 axis_ticks_lwd_y = .1,
                                 axis_ticks_lwd_x = .1,
                                 axis_label_size = 7,
                                 axis_label_face = "bold")
                )


# Perform topic modeling k=8
if (file.exists("data/merged_topic_fit_8_classtpx_omega_fix.rda")){
     Topic_clus_8 <- get(load(file="data/merged_topic_fit_8_classtpx_omega_fix.rda"))
} else {
Topic_clus_8 <- classtpx::class_topics(
    t(merged_raw_data_counts),
    K=8,
    known_samples = known_samples,
    class_labs = class_labs,
    method="omega.fix",
    tol=0.01)
save(Topic_clus_8, file="data/merged_topic_fit_8_classtpx_omega_fix.rda")
}

omega <- Topic_clus_8$omega
annotation <- data.frame(
  sample_id = paste0("X", c(1:NROW(omega))),
  tissue_label = as.factor(labels))
rownames(omega) <- annotation$sample_id
CountClust::StructureGGplot(omega = omega,
                annotation = annotation,
                palette = RColorBrewer::brewer.pal(8, "Accent"),
                yaxis_label = "Tissue Type",
                order_sample = TRUE,
                axis_tick = list(axis_ticks_length = .1,
                                 axis_ticks_lwd_y = .1,
                                 axis_ticks_lwd_x = .1,
                                 axis_label_size = 7,
                                 axis_label_face = "bold")
                )

```

# Semi-supervised Topic Modeling Genes Analysis

```{r genes_classtpx}
#function to plot genes that distinguish topics
plot_topic_factors <- function(GoM_object){
     theta <- GoM_object$theta
          
     for(topic in 1:ncol(theta)){
          plot_ratio_factor_by_mean_factor(topic, theta)
     }
}

plot_ratio_factor_by_mean_factor <- function(topic_n, GoM_theta){
     factors_topic_n <- GoM_theta[,topic_n]
     mean_factors_minus_topic_n <- row_means(GoM_theta[, -topic_n])
     ratio_factors_topic_n <- factors_topic_n/mean_factors_minus_topic_n
     
     mean_factors <- row_means(GoM_theta)
     
     #get matrix of data to be fed into plot
     data <- as.data.frame(cbind("factor ratio" = ratio_factors_topic_n, "mean factor" = mean_factors))
     #identify genes to highlight
     data <- data %>%
          mutate(reg = case_when(
               log(data$`mean factor`) >= -20 & log(data$`factor ratio`) >= 10 ~ "UP",
               log(data$`mean factor`) >= -20 & log(data$`factor ratio`) <= -10 ~ "DOWN",
               log(data$`mean factor`) >= -20 & log(data$`factor ratio`) > -10 & log(data$`factor ratio`) < 10~ "no_change",
               log(data$`mean factor`) < -20 ~ "no_change"
               ))%>%
          mutate(reg = factor(reg, levels = c("UP", "no_change","DOWN")))
     
     data_subset= data[which(log(data$`mean factor`) >= -20),]
     data_subset= data[which(log(data$`factor ratio`) <= -10 | log(data$`factor ratio`) >= 10) ,]
     
     #plot
     ggplot(data, aes(x = log(`mean factor`), y = log(`factor ratio`)), label = rownames(data)) +
          geom_point(aes(color=reg)) +
          scale_color_manual(name = "Differential \n regulation",
                     values = c("DOWN" = "#058983",
                                "no_change" = "grey",
                                "UP" = "#DEB132"),
                     labels = c("UP", "No Change", "DOWN"))

```

