---
title: "ANT1/ANT2_Pilot"
author: "Anthony Hung"
date: "2019-12-02"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Analysis of processed sc pilot data ANT1/ANT2

ANT1_ANT2 contain multiplexed samples from replicate of the pilot. Equal numbers of cells from 18855 (OA strained), 19160 (unstrained), and 18856 (unstrained) were pooled into one collection and sequenced using the 10x chromium technology.

ANT1: (19160 unstrained; 18856 unstrained; 18855 strained)
  estimated saturation statistics from Kenneth's Pipeline:
n.reads n.unique        total.size      saturation
192546655       101667280       2.15403e+08     0.471986

ANT2: (19160 strained; 18856 strained; 18855 unstrained)
  estimated saturation statistics from Kenneth's Pipeline:
n.reads n.unique        total.size      saturation
180694884       120674466       3.63297e+08     0.332164
  
Raw FASTQ files were processed through Kenneth Barr's pipeline, which aligns reads to hg38 using STAR solo and runs demuxlet on the output.

## Load libraries

```{r load libraries}
library(data.table)
library(tidyverse)
library(dplyr)
library(stringr)
library(readr)
library(Matrix)
library(Seurat)
library(gridExtra)
```

## Load in data

```{r specify directory structure}
## link to directories containing data files (count matrices)
proj_dir <- "~/Desktop/scPilot/"
ANT1_dir <- paste0(proj_dir, "YG-AH-2S-ANT-1_S1_L008/")
ANT2_dir <- paste0(proj_dir, "YG-AH-2S-ANT-2_S2_L008/")

#read in data

# ##Gene output from STARSOLO
# #ANT1
# demuxlet1 <- fread(paste0(ANT1_dir, "demuxlet.best", sep = ""))
# count_data1 <- readMM(paste0(ANT1_dir, "Gene/filtered/matrix.mtx"))
# genes1 <- read_tsv(paste0(ANT1_dir, "Gene/filtered/genes.tsv"), col_names = F)
# barcodes1 <- as.data.frame(read_tsv(paste0(ANT1_dir, "Gene/filtered/barcodes.tsv"), col_names = F))
# #ANT2
# demuxlet2 <- fread(paste0(ANT2_dir, "demuxlet.best", sep = ""))
# count_data2 <- readMM(paste0(ANT2_dir, "Gene/filtered/matrix.mtx"))
# genes2 <- read_tsv(paste0(ANT2_dir, "Gene/filtered/genes.tsv"), col_names = F)
# barcodes2 <- as.data.frame(read_tsv(paste0(ANT2_dir, "Gene/filtered/barcodes.tsv"), col_names = F))


##GeneFull Output from STARSOLO
#ANT1
demuxlet1 <- fread(paste0(ANT1_dir, "demuxlet.best", sep = ""))
count_data1 <- readMM(paste0(ANT1_dir, "GeneFull/filtered/matrix.mtx"))
genes1 <- read_tsv(paste0(ANT1_dir, "GeneFull/filtered/genes.tsv"), col_names = F)
barcodes1 <- as.data.frame(read_tsv(paste0(ANT1_dir, "GeneFull/filtered/barcodes.tsv"), col_names = F))
UMIperCell1 <- read.table(paste0(ANT1_dir, "GeneFull/UMIperCellSorted.txt"), header = F)
#ANT2
demuxlet2 <- fread(paste0(ANT2_dir, "demuxlet.best", sep = ""))
count_data2 <- readMM(paste0(ANT2_dir, "GeneFull/filtered/matrix.mtx"))
genes2 <- read_tsv(paste0(ANT2_dir, "GeneFull/filtered/genes.tsv"), col_names = F)
barcodes2 <- as.data.frame(read_tsv(paste0(ANT2_dir, "GeneFull/filtered/barcodes.tsv"), col_names = F))
UMIperCell2 <- read.table(paste0(ANT2_dir, "GeneFull/UMIperCellSorted.txt"), header = F)
```

# number of umis per cell for each sample

```{r hist of umipercell}
table(UMIperCell1$V1 > 10000)
table(UMIperCell2$V1 > 10000)
```


# DecontX to remove data from ambient RNA in droplets

```{r decontX}
# library(celda)
# #read in data
# 
# #ANT1
# count_data1_raw <- readMM(paste0(ANT1_dir, "Gene/raw/matrix.mtx"))
# genes1_raw <- read_tsv(paste0(ANT1_dir, "Gene/raw/genes.tsv"), col_names = F)
# barcodes1_raw <- as.data.frame(read_tsv(paste0(ANT1_dir, "Gene/raw/barcodes.tsv"), col_names = F))
# #ANT2
# count_data2_raw <- readMM(paste0(ANT2_dir, "Gene/raw/matrix.mtx"))
# genes2_raw <- read_tsv(paste0(ANT2_dir, "Gene/raw/genes.tsv"), col_names = F)
# barcodes2_raw <- as.data.frame(read_tsv(paste0(ANT2_dir, "Gene/raw/barcodes.tsv"), col_names = F))
# 
# 
# #decontxModel <- decontX(counts = count_data1_raw@x)
```



# Based on the demuxlet output, assign label for barcodes based on "BEST" output and filter for "SNG-" barcodes

```{r Filter droplets for singlets}
#returns a dataframe with two columns, one corresponding to the barcodes and one corresponding to the label given by demuxlet
return_singlet_label <- function(barcodes, demuxlet.out){
  labels <- demuxlet.out$BEST[match(unlist(barcodes), demuxlet.out$BARCODE)]
  return(cbind(barcodes, labels))
}

barcodes1_labeled <- return_singlet_label(barcodes1, demuxlet1)
barcodes2_labeled <- return_singlet_label(barcodes2, demuxlet2)

#table of singlets/multiplets in the filtered data based on demuxlet
table(barcodes1_labeled$labels)
table(barcodes2_labeled$labels)

## filter for droplets that are singlets
#ANT1
demuxlet_single1 <- demuxlet1 %>%
     dplyr::filter(grepl("SNG-", BEST))
singlets_index1 <- unlist(lapply(barcodes1_labeled$X1,"%in%", table = demuxlet_single1$BARCODE), use.names = F) #get index of barcodes that are singlets
barcodes_singlets1 <- barcodes1_labeled[singlets_index1,] #use index to subset matrix + barcode names
count_data_singlets1 <- count_data1[,singlets_index1]

#ANT2
demuxlet_single2 <- demuxlet2 %>%
     dplyr::filter(grepl("SNG-", BEST))
singlets_index2 <- unlist(lapply(barcodes2_labeled$X1,"%in%", table = demuxlet_single2$BARCODE), use.names = F) #get index of barcodes that are singlets
barcodes_singlets2 <- barcodes2_labeled[singlets_index2,] #use index to subset matrix + barcode names
count_data_singlets2 <- count_data2[,singlets_index2]
```



# Create Seurat object for each dataset (for singlet barcodes) and add metadata in the form of singlet identity for each barcode. Rest of analysis adapted from: https://satijalab.org/seurat/v3.0/pbmc3k_tutorial.html

```{r seurat}
rownames(count_data_singlets1) <- genes1$X2
colnames(count_data_singlets1) <- barcodes_singlets1$X1

ANT1_seurat <- CreateSeuratObject(counts = count_data_singlets1, project = "ANT1") %>% 
  AddMetaData(barcodes_singlets1$labels, col.name = "labels")


rownames(count_data_singlets2) <- genes2$X2
colnames(count_data_singlets2) <- barcodes_singlets2$X1

ANT2_seurat <- CreateSeuratObject(counts = count_data_singlets2, project = "ANT2") %>% 
  AddMetaData(barcodes_singlets2$labels, col.name = "labels")
```

Now we can perform some QC on cells in Seurat

```{r QC}
ANT1_seurat[["percent.mt"]] <- PercentageFeatureSet(ANT1_seurat, pattern = "^MT-")
ANT2_seurat[["percent.mt"]] <- PercentageFeatureSet(ANT2_seurat, pattern = "^MT-")

# Visualize QC metrics as a violin plot
VlnPlot(ANT1_seurat, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(ANT2_seurat, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(ANT1_seurat, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, group.by = "labels")
VlnPlot(ANT2_seurat, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, group.by = "labels")

# break down nFeature_RNA histograms by individual
hist(ANT1_seurat$nFeature_RNA[unname(ANT1_seurat$labels) == "SNG-NA19160"], main = "ANT1 SNG-NA19160 nFeatures", xlab = "nFeatures")
hist(ANT1_seurat$nFeature_RNA[unname(ANT1_seurat$labels) == "SNG-NA18855"], main = "ANT1 SNG-NA18855 nFeatures", xlab = "nFeatures")
hist(ANT1_seurat$nFeature_RNA[unname(ANT1_seurat$labels) == "SNG-NA18856"], main = "ANT1 SNG-NA18856 nFeatures", xlab = "nFeatures")


hist(ANT2_seurat$nFeature_RNA[unname(ANT1_seurat$labels) == "SNG-NA19160"], main = "ANT2 SNG-NA19160 nFeatures", xlab = "nFeatures")
hist(ANT2_seurat$nFeature_RNA[unname(ANT1_seurat$labels) == "SNG-NA18855"], main = "ANT2 SNG-NA18855 nFeatures", xlab = "nFeatures")


# FeatureScatter is typically used to visualize feature-feature relationships, but can be used
# for anything calculated by the object, i.e. columns in object metadata, PC scores etc.

plot1 <- FeatureScatter(ANT1_seurat, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(ANT1_seurat, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
CombinePlots(plots = list(plot1, plot2))


plot1 <- FeatureScatter(ANT2_seurat, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(ANT2_seurat, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
CombinePlots(plots = list(plot1, plot2))



#Filter barcodes based on nFeatures and %MT 
ANT1_seurat <- subset(ANT1_seurat, subset = nFeature_RNA > 1000 & percent.mt < 10)
table(ANT1_seurat$labels)
ANT2_seurat <- subset(ANT2_seurat, subset = nFeature_RNA > 1000 & nFeature_RNA & percent.mt < 10)
table(ANT2_seurat$labels)

#Look at QC metrics after filtering
VlnPlot(ANT1_seurat, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, group.by = "labels")
VlnPlot(ANT2_seurat, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, group.by = "labels")
```


# Normalizing Data

```{r Norm}
ANT1_seurat <- NormalizeData(ANT1_seurat, normalization.method = "LogNormalize", scale.factor = 10000)
ANT2_seurat <- NormalizeData(ANT2_seurat, normalization.method = "LogNormalize", scale.factor = 10000)
```


# Feature selection

```{r feature selection}
ANT1_seurat <- FindVariableFeatures(ANT1_seurat, selection.method = "vst", nfeatures = 2000)
ANT2_seurat <- FindVariableFeatures(ANT2_seurat, selection.method = "vst", nfeatures = 2000)


plot_variable_features <- function(seurat.obj){
  # Identify the 10 most highly variable genes
  top10 <- head(VariableFeatures(seurat.obj), 10)
  
  # plot variable features with and without labels
  plot1 <- VariableFeaturePlot(seurat.obj) + 
    ggtitle(paste0(unname(seurat.obj$orig.ident[1]))) +
       theme(legend.position="bottom")
  plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE) +
    ggtitle(paste0(unname(seurat.obj$orig.ident[1]))) +
       theme(legend.position="bottom")
  return(CombinePlots(plots = list(plot1, plot2)))
}

plot_variable_features(ANT1_seurat)
plot_variable_features(ANT2_seurat)
```

# Scaling Data

```{r scaling}
scale_data <- function(seurat.obj){
  all.genes <- rownames(seurat.obj)
  return(ScaleData(seurat.obj, features = all.genes))
}

ANT1_seurat <- scale_data(ANT1_seurat)
ANT2_seurat <- scale_data(ANT2_seurat)
```

# Dimensionality Reduction

Using the highly variable features selected above, perform PCA

```{r PCA}
nPC <- 100
ANT1_seurat <- RunPCA(ANT1_seurat, features = VariableFeatures(object = ANT1_seurat), npcs = nPC)
ANT2_seurat <- RunPCA(ANT2_seurat, features = VariableFeatures(object = ANT2_seurat), npcs = nPC)


# Examine and visualize PCA results a few different ways
print(ANT2_seurat[["pca"]], dims = 1:5, nfeatures = 5)
VizDimLoadings(ANT1_seurat, dims = 1:2, reduction = "pca")

DimPlot(ANT1_seurat, reduction = "pca", group.by = "labels")

# Get the total variance:
pca <- ANT1_seurat[["pca"]]
mat <- Seurat::GetAssayData(ANT1_seurat, assay = "RNA", slot = "scale.data")
total_variance <- sum(matrixStats::rowVars(mat))


eigValues <- (pca@stdev)^2  ## EigenValues
varExplained <- eigValues / total_variance
head(varExplained) #var explained by first 10 PCs

DimHeatmap(ANT1_seurat, dims = 1:15, cells = 500, balanced = TRUE)

ElbowPlot(ANT1_seurat, ndims = nPC) #42 PCs?










# Examine and visualize PCA results a few different ways
print(ANT2_seurat[["pca"]], dims = 1:5, nfeatures = 5)
VizDimLoadings(ANT2_seurat, dims = 1:2, reduction = "pca")

DimPlot(ANT2_seurat, reduction = "pca", group.by = "labels")

# Get the total variance:
pca <- ANT2_seurat[["pca"]]
mat <- Seurat::GetAssayData(ANT2_seurat, assay = "RNA", slot = "scale.data")
total_variance <- sum(matrixStats::rowVars(mat))


eigValues <- (pca@stdev)^2  ## EigenValues
varExplained <- eigValues / total_variance
head(varExplained) #var explained by first 10 PCs

DimHeatmap(ANT2_seurat, dims = 1:15, cells = 500, balanced = TRUE)

ElbowPlot(ANT2_seurat, ndims = nPC) #29 PCs?
```

# Clustering

```{r clustering}
num_PCs <- 42

ANT1_seurat <- FindNeighbors(ANT1_seurat, dims = 1:num_PCs)
ANT1_seurat <- FindClusters(ANT1_seurat, resolution = 0.5)


#Run UMAP
ANT1_seurat <- RunUMAP(ANT1_seurat, dims = 1:num_PCs)
p1 <- DimPlot(ANT1_seurat, reduction = "umap")
p2 <- DimPlot(ANT1_seurat, reduction = "umap", group.by = "labels")
p3 <- FeaturePlot(ANT1_seurat, features = "COL10A1")
p4 <- FeaturePlot(ANT1_seurat, features = "COL11A1")
p5 <- FeaturePlot(ANT1_seurat, features = "SOX5")
p6 <- FeaturePlot(ANT1_seurat, features = "SOX6")
p7 <- FeaturePlot(ANT1_seurat, features = "SOX9")
p8 <- FeaturePlot(ANT1_seurat, features = "MMP2")
p9 <- FeaturePlot(ANT1_seurat, features = "MMP1")
p10 <- FeaturePlot(ANT1_seurat, features = "MMP13")
grid.arrange(p1, p2, nrow = 2)
grid.arrange(p3, p4, p5, p6, p7, nrow = 2)
grid.arrange(p8, p9, p10, nrow = 2)
saveRDS(ANT1_seurat, file = "output/ANT1_seurat.rds")





num_PCs <- 29

ANT2_seurat <- FindNeighbors(ANT2_seurat, dims = 1:num_PCs)
ANT2_seurat <- FindClusters(ANT2_seurat, resolution = 0.5)

#Run UMAP
ANT2_seurat <- RunUMAP(ANT2_seurat, dims = 1:num_PCs)
p1_ <- DimPlot(ANT2_seurat, reduction = "umap")
p2_ <- DimPlot(ANT2_seurat, reduction = "umap", group.by = "labels")
p3_ <- FeaturePlot(ANT2_seurat, features = "COL10A1")
p4_ <- FeaturePlot(ANT2_seurat, features = "COL11A1")
p5_ <- FeaturePlot(ANT2_seurat, features = "SOX5")
p6_ <- FeaturePlot(ANT2_seurat, features = "SOX6")
p7_ <- FeaturePlot(ANT2_seurat, features = "SOX9")
p8_ <- FeaturePlot(ANT2_seurat, features = "MMP2")
p9_ <- FeaturePlot(ANT2_seurat, features = "MMP1")
p10_ <- FeaturePlot(ANT2_seurat, features = "MMP13")
grid.arrange(p1_, p2_, nrow = 2)
grid.arrange(p3_, p4_, p5_, p6_, p7_, nrow = 2)
grid.arrange(p8_, p9_, p10_, nrow = 2)
saveRDS(ANT2_seurat, file = "output/ANT2_seurat.rds")
```

```{r expression by individual}
#Chondrocyte markers
VlnPlot(ANT1_seurat, features = c("COL2A1", "ACAN"), 
    pt.size = 0.2, ncol = 3, group.by = "labels")
VlnPlot(ANT1_seurat, features = c("COL10A1", "COL11A1", "SOX5", "SOX6", "SOX9"), 
    pt.size = 0.2, ncol = 3, group.by = "labels")
#Strain markers
VlnPlot(ANT1_seurat, features = c("MMP1", "MMP13", "IL1B", "MMP3"), 
    pt.size = 0.2, ncol = 3, group.by = "labels")
VlnPlot(ANT1_seurat, features = c("MMP2", "COMP", "TNF", "IBSP", "TIMP1",  "MMP9"), 
    pt.size = 0.2, ncol = 3, group.by = "labels")

#MSC Flow markers
VlnPlot(ANT1_seurat, features = c("ENG", "THY1",  "NT5E"), 
     pt.size = 0.2, ncol = 3, group.by = "labels")
VlnPlot(ANT1_seurat, features = c("PTPRC", "CD34", "CD14", "ITGAM", "CD79A", "CD19"), 
     pt.size = 0.2, ncol = 3, group.by = "labels")



#Chondrocyte markers
VlnPlot(ANT2_seurat, features = c("COL2A1", "ACAN"), 
    pt.size = 0.2, ncol = 3, group.by = "labels")
VlnPlot(ANT2_seurat, features = c("COL10A1", "COL11A1", "SOX5", "SOX6", "SOX9"), 
    pt.size = 0.2, ncol = 3, group.by = "labels")
#Strain markers
VlnPlot(ANT2_seurat, features = c("MMP1", "MMP13", "IL1B", "MMP3"), 
    pt.size = 0.2, ncol = 3, group.by = "labels")
VlnPlot(ANT2_seurat, features = c("MMP2", "COMP", "TNF", "IBSP", "TIMP1",  "MMP9"), 
    pt.size = 0.2, ncol = 3, group.by = "labels")

#MSC Flow markers
VlnPlot(ANT2_seurat, features = c("ENG", "THY1",  "NT5E"), 
     pt.size = 0.2, ncol = 3, group.by = "labels")
VlnPlot(ANT2_seurat, features = c("PTPRC", "CD34", "CD14", "ITGAM", "CD79A", "CD19"), 
     pt.size = 0.2, ncol = 3, group.by = "labels")
```

