---
title: "ANT1/ANT2_Pilot"
author: "Anthony Hung"
date: "2019-12-02"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

# Analysis of processed sc pilot data ANT1/ANT2

ANT1_ANT2 contain multiplexed samples from replicate of the pilot. Equal numbers of cells from 18855 (OA strained), 19160 (unstrained), and 18856 (unstrained) were pooled into one collection for ANT1, and equal numbers of cells from 18855 (Unstrained), 19160 (OA strained) were pooled into one collection for ANT2. The collections were sequenced using the 10x chromium technology.

ANT1: (19160 unstrained; 18856 unstrained; 18855 strained)
  estimated saturation statistics from Kenneth's Pipeline:
n.reads n.unique        total.size      saturation
192546655       101667280       2.15403e+08     0.471986

ANT2: (19160 strained; 18856 strained; 18855 unstrained)
  estimated saturation statistics from Kenneth's Pipeline:
n.reads n.unique        total.size      saturation
180694884       120674466       3.63297e+08     0.332164
  
Raw FASTQ files were processed through Kenneth Barr's pipeline, which aligns reads to hg38 using STAR solo and runs demuxlet on the output.

## Load libraries

```{r load libraries}
library(data.table)
library(tidyverse)
library(plyr)
library(dplyr)
library(stringr)
library(readr)
library(Matrix)
library(Seurat)
library(gridExtra)
```

## Load in data

```{r specify directory structure}
## link to directories containing data files (count matrices)
proj_dir <- "~/Desktop/scPilot/"
ANT1_dir <- paste0(proj_dir, "YG-AH-2S-ANT-1_S1_L008/")
ANT2_dir <- paste0(proj_dir, "YG-AH-2S-ANT-2_S2_L008/")

#read in data

# ##Gene output from STARSOLO
# #ANT1
# demuxlet1 <- fread(paste0(ANT1_dir, "demuxlet.best", sep = ""))
# count_data1 <- readMM(paste0(ANT1_dir, "Gene/filtered/matrix.mtx"))
# genes1 <- read_tsv(paste0(ANT1_dir, "Gene/filtered/genes.tsv"), col_names = F)
# barcodes1 <- as.data.frame(read_tsv(paste0(ANT1_dir, "Gene/filtered/barcodes.tsv"), col_names = F))
# #ANT2
# demuxlet2 <- fread(paste0(ANT2_dir, "demuxlet.best", sep = ""))
# count_data2 <- readMM(paste0(ANT2_dir, "Gene/filtered/matrix.mtx"))
# genes2 <- read_tsv(paste0(ANT2_dir, "Gene/filtered/genes.tsv"), col_names = F)
# barcodes2 <- as.data.frame(read_tsv(paste0(ANT2_dir, "Gene/filtered/barcodes.tsv"), col_names = F))


##GeneFull Output from STARSOLO
#ANT1
demuxlet1 <- fread(paste0(ANT1_dir, "demuxlet.best", sep = ""))
count_data1 <- readMM(paste0(ANT1_dir, "GeneFull/filtered/matrix.mtx"))
genes1 <- read_tsv(paste0(ANT1_dir, "GeneFull/filtered/genes.tsv"), col_names = F)
barcodes1 <- as.data.frame(read_tsv(paste0(ANT1_dir, "GeneFull/filtered/barcodes.tsv"), col_names = F))
UMIperCell1 <- read.table(paste0(ANT1_dir, "GeneFull/UMIperCellSorted.txt"), header = F)
#ANT2
demuxlet2 <- fread(paste0(ANT2_dir, "demuxlet.best", sep = ""))
count_data2 <- readMM(paste0(ANT2_dir, "GeneFull/filtered/matrix.mtx"))
genes2 <- read_tsv(paste0(ANT2_dir, "GeneFull/filtered/genes.tsv"), col_names = F)
barcodes2 <- as.data.frame(read_tsv(paste0(ANT2_dir, "GeneFull/filtered/barcodes.tsv"), col_names = F))
UMIperCell2 <- read.table(paste0(ANT2_dir, "GeneFull/UMIperCellSorted.txt"), header = F)
```

# number of umis per cell for each sample

```{r hist of umipercell}
table(UMIperCell1$V1 > 10000)
table(UMIperCell2$V1 > 10000)
```


# DecontX to remove data from ambient RNA in droplets

```{r decontX}
# library(celda)
# #read in data
# 
# #ANT1
# count_data1_raw <- readMM(paste0(ANT1_dir, "Gene/raw/matrix.mtx"))
# genes1_raw <- read_tsv(paste0(ANT1_dir, "Gene/raw/genes.tsv"), col_names = F)
# barcodes1_raw <- as.data.frame(read_tsv(paste0(ANT1_dir, "Gene/raw/barcodes.tsv"), col_names = F))
# #ANT2
# count_data2_raw <- readMM(paste0(ANT2_dir, "Gene/raw/matrix.mtx"))
# genes2_raw <- read_tsv(paste0(ANT2_dir, "Gene/raw/genes.tsv"), col_names = F)
# barcodes2_raw <- as.data.frame(read_tsv(paste0(ANT2_dir, "Gene/raw/barcodes.tsv"), col_names = F))
# 
# 
# #decontxModel <- decontX(counts = count_data1_raw@x)
```



# Based on the demuxlet output, assign label for barcodes based on "BEST" output and filter for "SNG-" barcodes

```{r Filter droplets for singlets}
#returns a dataframe with two columns, one corresponding to the barcodes and one corresponding to the label given by demuxlet
return_singlet_label <- function(barcodes, demuxlet.out){
  labels <- demuxlet.out$BEST[match(unlist(barcodes), demuxlet.out$BARCODE)]
  return(cbind(barcodes, labels))
}

barcodes1_labeled <- return_singlet_label(barcodes1, demuxlet1)
barcodes2_labeled <- return_singlet_label(barcodes2, demuxlet2)

#table of singlets/multiplets in the filtered data based on demuxlet
table(barcodes1_labeled$labels)
table(barcodes2_labeled$labels)

## filter for droplets that are singlets
#ANT1
demuxlet_single1 <- demuxlet1 %>%
     dplyr::filter(grepl("SNG-", BEST))
singlets_index1 <- unlist(lapply(barcodes1_labeled$X1,"%in%", table = demuxlet_single1$BARCODE), use.names = F) #get index of barcodes that are singlets
barcodes_singlets1 <- barcodes1_labeled[singlets_index1,] #use index to subset matrix + barcode names
count_data_singlets1 <- count_data1[,singlets_index1]

#ANT2
demuxlet_single2 <- demuxlet2 %>%
     dplyr::filter(grepl("SNG-", BEST))
singlets_index2 <- unlist(lapply(barcodes2_labeled$X1,"%in%", table = demuxlet_single2$BARCODE), use.names = F) #get index of barcodes that are singlets
barcodes_singlets2 <- barcodes2_labeled[singlets_index2,] #use index to subset matrix + barcode names
count_data_singlets2 <- count_data2[,singlets_index2]
```



# Create Seurat object for each dataset (for singlet barcodes) and add metadata in the form of singlet identity for each barcode. Rest of analysis adapted from: https://satijalab.org/seurat/v3.0/pbmc3k_tutorial.html

```{r seurat}
#Change labels to reflect strain/unstrain

strainIndlabels1 <- revalue(barcodes_singlets1$labels, 
                            c("SNG-NA18856"= "NA18856_Unstrain", 
                              "SNG-NA18855" = "NA18855_Strain", 
                              "SNG-NA19160" = "NA19160_Unstrain"))

strainIndlabels2 <- revalue(barcodes_singlets2$labels, 
                            c("SNG-NA18855" = "NA18855_Unstrain", 
                              "SNG-NA19160" = "NA19160_Strain"))


rownames(count_data_singlets1) <- genes1$X2
colnames(count_data_singlets1) <- barcodes_singlets1$X1

ANT1_seurat <- CreateSeuratObject(counts = count_data_singlets1, project = "ANT1") %>% 
  AddMetaData(strainIndlabels1, col.name = "labels")


rownames(count_data_singlets2) <- genes2$X2
colnames(count_data_singlets2) <- barcodes_singlets2$X1

ANT2_seurat <- CreateSeuratObject(counts = count_data_singlets2, project = "ANT2") %>% 
  AddMetaData(strainIndlabels2, col.name = "labels")


# Merge into one dataset (https://satijalab.org/seurat/v3.0/merge_vignette.html)

ANT1.2 <- merge(x = ANT1_seurat,
                   y = ANT2_seurat,
                   add.cell.ids = c("ANT1", "ANT2"),
                   merge.data = F,
                   project = "OAStrain")
```

Now we can perform some QC on cells in Seurat

```{r QC}
ANT1.2[["percent.mt"]] <- PercentageFeatureSet(ANT1.2, pattern = "^MT-")

#visualize QC metrics as violin plot
VlnPlot(ANT1.2, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)
VlnPlot(ANT1.2, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, group.by = "labels")

# FeatureScatter is typically used to visualize feature-feature relationships, but can be used
# for anything calculated by the object, i.e. columns in object metadata, PC scores etc.

plot1 <- FeatureScatter(ANT1.2, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(ANT1.2, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
CombinePlots(plots = list(plot1, plot2))




#Filter barcodes based on nFeatures and %MT 
ANT1.2 <- subset(ANT1.2, subset = nFeature_RNA > 2000 & percent.mt < 10)
table(ANT1.2$labels)

#Look at QC metrics after filtering
VlnPlot(ANT1.2, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, group.by = "labels")
```


# Normalizing Data

```{r Norm}
ANT1.2 <- NormalizeData(ANT1.2, normalization.method = "LogNormalize", scale.factor = 10000)
```


# Feature selection

```{r feature selection}
ANT1.2 <- FindVariableFeatures(ANT1.2, selection.method = "vst", nfeatures = 2000)


plot_variable_features <- function(seurat.obj){
  # Identify the 10 most highly variable genes
  top10 <- head(VariableFeatures(seurat.obj), 10)
  
  # plot variable features with and without labels
  plot1 <- VariableFeaturePlot(seurat.obj) + 
       theme(legend.position="bottom")
  plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE) +
       theme(legend.position="bottom")
  return(CombinePlots(plots = list(plot1, plot2)))
}

plot_variable_features(ANT1.2)
```

# Scaling Data

```{r scaling}
scale_data <- function(seurat.obj){
  all.genes <- rownames(seurat.obj)
  return(ScaleData(seurat.obj, features = all.genes))
}

ANT1.2 <- scale_data(ANT1.2)
```

# Dimensionality Reduction

Using the highly variable features selected above, perform PCA

```{r PCA}
nPC <- 100
ANT1.2 <- RunPCA(ANT1.2, features = VariableFeatures(object = ANT1.2), npcs = nPC)


# Examine and visualize PCA results a few different ways
print(ANT1.2[["pca"]], dims = 1:5, nfeatures = 5)
VizDimLoadings(ANT1.2, dims = 1:2, reduction = "pca")

DimPlot(ANT1.2, reduction = "pca", group.by = "labels")

# Get the total variance:
pca <- ANT1.2[["pca"]]
mat <- Seurat::GetAssayData(ANT1.2, assay = "RNA", slot = "scale.data")
total_variance <- sum(matrixStats::rowVars(mat))


eigValues <- (pca@stdev)^2  ## EigenValues
varExplained <- eigValues / total_variance
head(varExplained) #var explained by first 10 PCs

DimHeatmap(ANT1.2, dims = 1:15, cells = 500, balanced = TRUE)

ElbowPlot(ANT1.2, ndims = nPC) #50 PCs?
```

# Correlation between PC loadings and variables

```{r PC corr}
#get PC embeddings for each barcode
PC1_embeddings <- ANT1.2@reductions$pca@cell.embeddings[,1]
PC2_embeddings <- ANT1.2@reductions$pca@cell.embeddings[,2]

#get information about individual, collection, and treatment
barcode_labels <- ANT1.2$labels
individual <- substr(barcode_labels, 1, 7)
collection <- ANT1.2@meta.data$orig.ident
treatment <- substr(barcode_labels, 9, nchar(barcode_labels))

#combine all into a dataframe
PC1_dataframe <- data.frame(individual = individual, sc_collection = collection, treatment = treatment, PC1_embeddings = PC1_embeddings)
PC2_dataframe <- data.frame(individual = individual, sc_collection = collection, treatment = treatment, PC2_embeddings = PC2_embeddings)

#plot box plots for PC embeddings
PC1_dataframe %>% 
  ggplot(aes(x=individual, y=PC1_embeddings)) +
  geom_boxplot()

PC1_dataframe %>% 
  ggplot(aes(x=sc_collection, y=PC1_embeddings)) +
  geom_boxplot()

PC1_dataframe %>% 
  ggplot(aes(x=treatment, y=PC1_embeddings)) +
  geom_boxplot()



PC2_dataframe %>% 
  ggplot(aes(x=individual, y=PC1_embeddings)) +
  geom_boxplot()

PC2_dataframe %>% 
  ggplot(aes(x=sc_collection, y=PC1_embeddings)) +
  geom_boxplot()

PC2_dataframe %>% 
  ggplot(aes(x=treatment, y=PC1_embeddings)) +
  geom_boxplot()




#
```


# Clustering

```{r clustering}
num_PCs <- 50

ANT1.2 <- FindNeighbors(ANT1.2, dims = 1:num_PCs)
ANT1.2 <- FindClusters(ANT1.2, resolution = 0.5)

#Run UMAP
ANT1.2 <- RunUMAP(ANT1.2, dims = 1:num_PCs)
p1 <- DimPlot(ANT1.2, reduction = "umap")
p2 <- DimPlot(ANT1.2, reduction = "umap", group.by = "labels")
grid.arrange(p1, p2, nrow = 2)
saveRDS(ANT1.2, file = "output/ANT1.2.rds")
```

```{r expression by individual}
#Chondrocyte markers
VlnPlot(ANT1.2, features = c("COL2A1", "SOX9", "ACAN"), 
    pt.size = 0.2, ncol = 3, group.by = "labels")
VlnPlot(ANT1.2, features = c("COL10A1", "COL11A1", "SOX5"), 
    pt.size = 0.2, ncol = 3, group.by = "labels")
VlnPlot(ANT1.2, features = c("TGFB3", "SOX6"), 
    pt.size = 0.2, ncol = 3, group.by = "labels")

#Strain markers
VlnPlot(ANT1.2, features = c("MMP1", "MMP13", "IL1B", "MMP3"), 
    pt.size = 0.2, ncol = 3, group.by = "labels")
VlnPlot(ANT1.2, features = c("MMP2", "COMP", "TNF"), 
    pt.size = 0.2, ncol = 3, group.by = "labels")
VlnPlot(ANT1.2, features = c("IBSP", "TIMP1",  "MMP9"), 
    pt.size = 0.2, ncol = 3, group.by = "labels")
VlnPlot(ANT1.2, features = c("ADAMTS4", "ADAMTS5"), 
    pt.size = 0.2, ncol = 3, group.by = "labels")


#MSC Flow markers
VlnPlot(ANT1.2, features = c("ENG", "THY1",  "NT5E"), 
     pt.size = 0.2, ncol = 3, group.by = "labels")
VlnPlot(ANT1.2, features = c("PTPRC", "CD34", "CD14", "ITGAM", "CD79A", "CD19"), 
     pt.size = 0.2, ncol = 3, group.by = "labels")

```

